<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Missing Items Summary</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    body {
      margin: 0;
      padding: 10px;
      background: #fff;
    }
    
    .summary-container {
      max-width: 100%;
    }
    
    .widget-title {
      font-size: 18px;
      font-weight: 700;
      color: #dc3545;
      margin: 0 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 3px solid #dc3545;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .widget-title.all-ok {
      color: #28a745;
      border-bottom-color: #28a745;
    }
    
    .title-icon {
      font-size: 24px;
    }
    
    .all-ok-message {
      background: #d4edda;
      border: 2px solid #28a745;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: #155724;
    }
    
    .all-ok-message .icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    .all-ok-message h3 {
      margin: 0 0 5px 0;
      font-size: 18px;
    }
    
    .all-ok-message p {
      margin: 0;
      font-size: 14px;
      opacity: 0.8;
    }
    
    .area-section {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .area-header {
      background: #f8f9fa;
      padding: 12px 15px;
      font-weight: 600;
      color: #333;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .area-count {
      background: #dc3545;
      color: white;
      font-size: 12px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 12px;
    }
    
    .shortage-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    
    .shortage-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      gap: 10px;
    }
    
    .shortage-item:last-child {
      border-bottom: none;
    }
    
    .shortage-item.critical {
      background: #f8d7da;
    }
    
    .shortage-item.warning {
      background: #fff3cd;
    }
    
    .item-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      min-width: 0;
    }
    
    .item-name {
      font-weight: 500;
      color: #333;
    }
    
    .item-category {
      font-size: 12px;
      color: #666;
    }
    
    .item-shortage {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .shortage-detail {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
    }
    
    .shortage-badge {
      background: #dc3545;
      color: white;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 13px;
      white-space: nowrap;
    }
    
    .shortage-badge.warning {
      background: #ffc107;
      color: #333;
    }
    
    .total-summary {
      background: #333;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .total-summary h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      opacity: 0.8;
    }
    
    .total-stats {
      display: flex;
      justify-content: space-around;
      text-align: center;
    }
    
    .total-stat {
      display: flex;
      flex-direction: column;
    }
    
    .stat-number {
      font-size: 28px;
      font-weight: 700;
    }
    
    .stat-label {
      font-size: 12px;
      opacity: 0.7;
    }
    
    .no-data {
      padding: 30px;
      text-align: center;
      color: #666;
    }
    
    .no-data .icon {
      font-size: 48px;
      margin-bottom: 10px;
      opacity: 0.5;
    }
    
    .config-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 6px;
      padding: 15px;
      color: #721c24;
      font-size: 13px;
    }
    
    .config-error strong {
      display: block;
      margin-bottom: 5px;
    }
    
    .debug-info {
      background: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 10px;
      margin-top: 10px;
      font-size: 11px;
      font-family: monospace;
      white-space: pre-wrap;
      display: none;
    }
    
    .debug-info.visible {
      display: block;
    }
    
    @media (max-width: 400px) {
      .shortage-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .item-shortage {
        width: 100%;
        justify-content: space-between;
        margin-top: 6px;
      }
    }
  </style>
</head>
<body>
  <div class="summary-container">
    <div class="widget-title" id="widgetTitle">
      <span class="title-icon">!</span>
      <span>Missing Items Summary</span>
    </div>
    
    <div id="content">
      <div class="no-data">
        <div class="icon">[...]</div>
        <p>Waiting for checklist data...</p>
      </div>
    </div>
    
    <div id="debugInfo" class="debug-info"></div>
  </div>

  <!-- Use the newer CDN to avoid CORS issues -->
  <script src="https://cdn.jotfor.ms/s/umd/latest/for-custom-widgets.js"></script>
  <script>
    // =====================================================
    // CONFIGURATION
    // =====================================================
    // Widget Settings needed:
    //   - areaFieldIds: Comma-separated list of field IDs for area checklist widgets
    //                   e.g., "101,102,103"
    //
    // This widget listens for changes from area checklist widgets using
    // JFCustomWidget.listenFromField() with the 'change' event type
    
    var allAreaData = {};
    var debugMode = false; // Set to true to show debug info
    
    // =====================================================
    // DEBUG LOGGING
    // =====================================================
    
    function debugLog(message, data) {
      console.log('[Summary Widget] ' + message, data || '');
      if (debugMode) {
        var debugEl = document.getElementById('debugInfo');
        if (debugEl) {
          debugEl.classList.add('visible');
          var timestamp = new Date().toLocaleTimeString();
          debugEl.textContent += '[' + timestamp + '] ' + message + '\n';
          if (data) {
            debugEl.textContent += JSON.stringify(data, null, 2) + '\n';
          }
        }
      }
    }
    
    // =====================================================
    // RENDER
    // =====================================================
    
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function renderSummary() {
      var content = document.getElementById('content');
      var titleEl = document.getElementById('widgetTitle');
      
      var areaKeys = Object.keys(allAreaData);
      var totalShortages = 0;
      var totalUnits = 0;
      var hasData = false;
      var areasWithShortages = 0;
      
      for (var i = 0; i < areaKeys.length; i++) {
        var areaData = allAreaData[areaKeys[i]];
        if (areaData && areaData.shortages) {
          hasData = true;
          if (areaData.shortages.length > 0) {
            areasWithShortages++;
            totalShortages += areaData.shortages.length;
            for (var j = 0; j < areaData.shortages.length; j++) {
              totalUnits += areaData.shortages[j].shortage;
            }
          }
        }
      }
      
      debugLog('Rendering summary', { 
        areaCount: areaKeys.length, 
        hasData: hasData, 
        totalShortages: totalShortages 
      });
      
      if (!hasData) {
        content.innerHTML = '<div class="no-data"><div class="icon">[...]</div><p>Complete the area checklists to see missing items here.</p></div>';
        resizeWidget();
        return;
      }
      
      if (totalShortages === 0) {
        titleEl.className = 'widget-title all-ok';
        titleEl.innerHTML = '<span class="title-icon">&#10003;</span><span>All Items Present</span>';
        content.innerHTML = '<div class="all-ok-message"><div class="icon">&#10003;</div><h3>Fully Stocked!</h3><p>All inventory items are present and accounted for.</p></div>';
        resizeWidget();
        return;
      }
      
      titleEl.className = 'widget-title';
      titleEl.innerHTML = '<span class="title-icon">!</span><span>Missing Items Summary</span>';
      
      var html = '';
      
      // Sort by area name
      areaKeys.sort(function(a, b) {
        var nameA = (allAreaData[a].area || a).toLowerCase();
        var nameB = (allAreaData[b].area || b).toLowerCase();
        return nameA.localeCompare(nameB);
      });
      
      for (var a = 0; a < areaKeys.length; a++) {
        var key = areaKeys[a];
        var areaData = allAreaData[key];
        
        if (!areaData || !areaData.shortages || areaData.shortages.length === 0) continue;
        
        html += '<div class="area-section">';
        html += '<div class="area-header">';
        html += '<span>' + escapeHtml(areaData.area || key) + '</span>';
        html += '<span class="area-count">' + areaData.shortages.length + ' items</span>';
        html += '</div>';
        html += '<ul class="shortage-list">';
        
        for (var s = 0; s < areaData.shortages.length; s++) {
          var item = areaData.shortages[s];
          var isCritical = item.actual === 0;
          var itemClass = isCritical ? 'critical' : 'warning';
          var badgeClass = isCritical ? '' : 'warning';
          var badgeText = isCritical ? 'MISSING' : ('Need ' + item.shortage);
          
          html += '<li class="shortage-item ' + itemClass + '">';
          html += '<div class="item-info">';
          html += '<span class="item-name">' + escapeHtml(item.name) + '</span>';
          if (item.category) {
            html += '<span class="item-category">' + escapeHtml(item.category) + '</span>';
          }
          html += '</div>';
          html += '<div class="item-shortage">';
          html += '<span class="shortage-detail">' + item.actual + ' / ' + item.required + '</span>';
          html += '<span class="shortage-badge ' + badgeClass + '">' + badgeText + '</span>';
          html += '</div>';
          html += '</li>';
        }
        
        html += '</ul>';
        html += '</div>';
      }
      
      html += '<div class="total-summary">';
      html += '<h4>TOTAL SHORTAGES</h4>';
      html += '<div class="total-stats">';
      html += '<div class="total-stat"><span class="stat-number">' + areasWithShortages + '</span><span class="stat-label">Areas</span></div>';
      html += '<div class="total-stat"><span class="stat-number">' + totalShortages + '</span><span class="stat-label">Items Short</span></div>';
      html += '<div class="total-stat"><span class="stat-number">' + totalUnits + '</span><span class="stat-label">Units Needed</span></div>';
      html += '</div>';
      html += '</div>';
      
      content.innerHTML = html;
      resizeWidget();
    }
    
    // =====================================================
    // PROCESS INCOMING DATA
    // =====================================================
    
    function processIncomingData(rawValue, sourceFieldId) {
      debugLog('Processing data from field ' + sourceFieldId, rawValue);
      
      var data = null;
      
      // Handle different data formats
      if (typeof rawValue === 'string') {
        try {
          data = JSON.parse(rawValue);
        } catch (e) {
          debugLog('Failed to parse as JSON', e.message);
          return false;
        }
      } else if (typeof rawValue === 'object' && rawValue !== null) {
        data = rawValue;
      }
      
      if (data && data.widgetId) {
        allAreaData[data.widgetId] = data;
        debugLog('Stored data for widget: ' + data.widgetId, data);
        return true;
      }
      
      return false;
    }
    
    // =====================================================
    // LISTEN FOR DATA FROM AREA WIDGETS
    // =====================================================
    
    function setupFieldListeners(fieldIds) {
      if (typeof JFCustomWidget === 'undefined') {
        debugLog('JFCustomWidget not available');
        return;
      }
      
      debugLog('Setting up listeners for fields', fieldIds);
      
      // Set up listeners for each area widget field
      // IMPORTANT: listenFromField requires 3 arguments: fieldId, eventType, callback
      for (var i = 0; i < fieldIds.length; i++) {
        (function(fieldId) {
          debugLog('Adding listener for field: ' + fieldId);
          
          // Listen for 'change' events on the field
          JFCustomWidget.listenFromField(fieldId, 'change', function(value) {
            debugLog('Received change event from field ' + fieldId, value);
            if (processIncomingData(value, fieldId)) {
              renderSummary();
            }
          });
        })(fieldIds[i]);
      }
    }
    
    function fetchInitialData(fieldIds) {
      if (typeof JFCustomWidget === 'undefined') {
        debugLog('JFCustomWidget not available for initial fetch');
        return;
      }
      
      debugLog('Fetching initial data for fields', fieldIds);
      
      // getFieldsValueById expects an array of string field IDs
      JFCustomWidget.getFieldsValueById(fieldIds, function(values) {
        debugLog('Received initial values', values);
        
        if (!values) {
          debugLog('No values returned');
          return;
        }
        
        var dataFound = false;
        for (var fieldId in values) {
          if (processIncomingData(values[fieldId], fieldId)) {
            dataFound = true;
          }
        }
        
        if (dataFound) {
          renderSummary();
        }
      });
    }
    
    // =====================================================
    // GENERATE READABLE OUTPUT FOR SUBMISSION
    // =====================================================
    
    function generateReadableOutput() {
      var areaKeys = Object.keys(allAreaData);
      var lines = [];
      var totalShort = 0;
      var totalUnits = 0;
      
      areaKeys.sort(function(a, b) {
        var nameA = (allAreaData[a].area || a).toLowerCase();
        var nameB = (allAreaData[b].area || b).toLowerCase();
        return nameA.localeCompare(nameB);
      });
      
      for (var i = 0; i < areaKeys.length; i++) {
        var areaData = allAreaData[areaKeys[i]];
        if (!areaData || !areaData.shortages || areaData.shortages.length === 0) continue;
        
        if (lines.length > 0) lines.push('');
        lines.push('=== ' + (areaData.area || areaKeys[i]).toUpperCase() + ' ===');
        
        // Group by category
        var byCategory = {};
        for (var j = 0; j < areaData.shortages.length; j++) {
          var item = areaData.shortages[j];
          var cat = item.category || 'General';
          if (!byCategory[cat]) byCategory[cat] = [];
          byCategory[cat].push(item);
          totalShort++;
          totalUnits += item.shortage;
        }
        
        for (var cat in byCategory) {
          lines.push('[' + cat + ']');
          for (var k = 0; k < byCategory[cat].length; k++) {
            var item = byCategory[cat][k];
            var status = item.actual === 0 
              ? 'MISSING - need ' + item.required
              : 'have ' + item.actual + '/' + item.required + ' - need ' + item.shortage + ' more';
            lines.push('  - ' + item.name + ': ' + status);
          }
        }
      }
      
      if (totalShort === 0) {
        return 'ALL ITEMS FULLY STOCKED\n\nNo missing or short items to report.';
      }
      
      var output = 'MISSING/SHORT ITEMS REPORT\n';
      output += 'Generated: ' + new Date().toLocaleString() + '\n';
      output += '================================\n\n';
      output += lines.join('\n');
      output += '\n\n================================\n';
      output += 'SUMMARY: ' + totalShort + ' items need restocking (' + totalUnits + ' total units needed)';
      
      return output;
    }
    
    // =====================================================
    // RESIZE
    // =====================================================
    
    function resizeWidget() {
      if (typeof JFCustomWidget === 'undefined') return;
      setTimeout(function() {
        JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight + 20 });
      }, 100);
    }
    
    // =====================================================
    // INIT
    // =====================================================
    
    var jotformReady = false;
    
    function initStandalone() {
      if (jotformReady) return;
      
      debugLog('Initializing in standalone/test mode');
      
      // Test data for standalone testing
      allAreaData = {
        "driver": {
          area: "Driver Compartment",
          shortages: [
            { name: "Flashlight", category: "Equipment", required: 2, actual: 1, shortage: 1 },
            { name: "Maps/GPS Unit", category: "Equipment", required: 1, actual: 0, shortage: 1 }
          ]
        },
        "patient": {
          area: "Patient Compartment", 
          shortages: [
            { name: "Bandages", category: "Supplies", required: 10, actual: 3, shortage: 7 },
            { name: "Gloves (pairs)", category: "PPE", required: 50, actual: 0, shortage: 50 }
          ]
        }
      };
      renderSummary();
    }
    
    function init() {
      debugLog('Initializing widget');
      
      var fallback = setTimeout(function() {
        if (!jotformReady) {
          debugLog('Fallback timeout reached, initializing standalone');
          initStandalone();
        }
      }, 1500);
      
      if (typeof JFCustomWidget !== 'undefined' && JFCustomWidget.subscribe) {
        debugLog('JFCustomWidget available, subscribing to ready event');
        
        JFCustomWidget.subscribe("ready", function(data) {
          jotformReady = true;
          clearTimeout(fallback);
          
          debugLog('Ready event received', data);
          
          // Get the list of area checklist widget field IDs from settings
          // Format: comma-separated field IDs, e.g., "101,102,103"
          var areaFieldIdsSetting = JFCustomWidget.getWidgetSetting('areaFieldIds') || '';
          debugLog('areaFieldIds setting: ' + areaFieldIdsSetting);
          
          var areaFieldIds = areaFieldIdsSetting.split(',').map(function(id) {
            return id.trim();
          }).filter(function(id) {
            return id.length > 0;
          });
          
          if (areaFieldIds.length === 0) {
            document.getElementById('content').innerHTML = 
              '<div class="config-error">' +
              '<strong>Configuration needed:</strong> Set <code>areaFieldIds</code> in widget settings ' +
              'to a comma-separated list of field IDs for your area checklist widgets (e.g., "101,102,103").' +
              '<br><br>To find field IDs: In the form builder, click on each area checklist widget and note the ' +
              'field ID shown in the URL or properties panel.' +
              '</div>';
            resizeWidget();
            return;
          }
          
          // Clear any test data
          allAreaData = {};
          
          // Set up listeners for real-time updates (INSIDE ready callback as required)
          setupFieldListeners(areaFieldIds);
          
          // Fetch initial data from all fields
          fetchInitialData(areaFieldIds);
          
          // Show waiting message initially
          renderSummary();
          resizeWidget();
        });
        
        JFCustomWidget.subscribe("submit", function() {
          debugLog('Submit event received');
          JFCustomWidget.sendSubmit({
            valid: true,
            value: generateReadableOutput()
          });
        });
      } else {
        debugLog('JFCustomWidget not available');
        clearTimeout(fallback);
        initStandalone();
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
