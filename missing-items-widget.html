<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Missing Items Summary</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    body {
      margin: 0;
      padding: 10px;
      background: #fff;
    }
    
    .debug-panel {
      background: #fffde7;
      border: 2px solid #ffc107;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 11px;
      font-family: monospace;
      display: none; /* Set to block to debug */
    }
    
    .widget-title {
      font-size: 18px;
      font-weight: 700;
      color: #dc3545;
      margin: 0 0 15px 0;
      padding-bottom: 10px;
      border-bottom: 3px solid #dc3545;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .widget-title.all-ok {
      color: #28a745;
      border-bottom-color: #28a745;
    }
    
    .title-icon { font-size: 24px; }
    
    .all-ok-message {
      background: #d4edda;
      border: 2px solid #28a745;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      color: #155724;
    }
    
    .all-ok-message .icon { font-size: 48px; margin-bottom: 10px; }
    .all-ok-message h3 { margin: 0 0 5px 0; font-size: 18px; }
    .all-ok-message p { margin: 0; font-size: 14px; opacity: 0.8; }
    
    .area-section {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
    }
    
    .area-header {
      background: #f8f9fa;
      padding: 12px 15px;
      font-weight: 600;
      color: #333;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .area-count {
      background: #dc3545;
      color: white;
      font-size: 12px;
      font-weight: 600;
      padding: 3px 10px;
      border-radius: 12px;
    }
    
    .shortage-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    
    .shortage-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      gap: 10px;
    }
    
    .shortage-item:last-child { border-bottom: none; }
    .shortage-item.critical { background: #f8d7da; }
    .shortage-item.warning { background: #fff3cd; }
    
    .item-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      min-width: 0;
    }
    
    .item-name { font-weight: 500; color: #333; }
    .item-category { font-size: 12px; color: #666; }
    
    .item-shortage {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .shortage-detail {
      font-size: 12px;
      color: #666;
      white-space: nowrap;
    }
    
    .shortage-badge {
      background: #dc3545;
      color: white;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 13px;
      white-space: nowrap;
    }
    
    .shortage-badge.warning {
      background: #ffc107;
      color: #333;
    }
    
    .total-summary {
      background: #333;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }
    
    .total-summary h4 {
      margin: 0 0 10px 0;
      font-size: 14px;
      opacity: 0.8;
    }
    
    .total-stats {
      display: flex;
      justify-content: space-around;
      text-align: center;
    }
    
    .total-stat { display: flex; flex-direction: column; }
    .stat-number { font-size: 28px; font-weight: 700; }
    .stat-label { font-size: 12px; opacity: 0.7; }
    
    .no-data {
      padding: 30px;
      text-align: center;
      color: #666;
    }
    
    .no-data .icon {
      font-size: 48px;
      margin-bottom: 10px;
      opacity: 0.5;
    }
    
    .config-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 6px;
      padding: 15px;
      color: #721c24;
      font-size: 13px;
    }
    
    @media (max-width: 400px) {
      .shortage-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .item-shortage {
        width: 100%;
        justify-content: space-between;
        margin-top: 6px;
      }
    }
  </style>
</head>
<body>
  <div class="debug-panel" id="debugPanel"></div>
  
  <div class="summary-container">
    <div class="widget-title" id="widgetTitle">
      <span class="title-icon">‚ö†Ô∏è</span>
      <span>Missing Items Summary</span>
    </div>
    
    <div id="content">
      <div class="no-data">
        <div class="icon">üìã</div>
        <p>Waiting for checklist data...</p>
      </div>
    </div>
  </div>

  <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
  <script>
    var hiddenFieldId = null;
    var allAreaData = {};
    var pollInterval = null;
    var lastValue = '';
    
    function debug(msg) {
      console.log('[Summary] ' + msg);
      var el = document.getElementById('debugPanel');
      if (el) el.textContent += msg + '\n';
    }
    
    function escapeHtml(t) {
      var d = document.createElement('div');
      d.textContent = t;
      return d.innerHTML;
    }
    
    function renderSummary() {
      var content = document.getElementById('content');
      var titleEl = document.getElementById('widgetTitle');
      var keys = Object.keys(allAreaData);
      
      var totalShort = 0, totalUnits = 0, hasData = false, areasShort = 0;
      
      for (var i = 0; i < keys.length; i++) {
        var area = allAreaData[keys[i]];
        if (area && area.shortages) {
          hasData = true;
          if (area.shortages.length > 0) {
            areasShort++;
            totalShort += area.shortages.length;
            for (var j = 0; j < area.shortages.length; j++) {
              totalUnits += area.shortages[j].shortage;
            }
          }
        }
      }
      
      if (!hasData) {
        content.innerHTML = '<div class="no-data"><div class="icon">üìã</div><p>No checklist data received yet.</p></div>';
        resizeWidget();
        return;
      }
      
      if (totalShort === 0) {
        titleEl.className = 'widget-title all-ok';
        titleEl.innerHTML = '<span class="title-icon">‚úÖ</span><span>All Items Present</span>';
        content.innerHTML = '<div class="all-ok-message"><div class="icon">‚úÖ</div><h3>Fully Stocked!</h3><p>All items are present.</p></div>';
        resizeWidget();
        return;
      }
      
      titleEl.className = 'widget-title';
      titleEl.innerHTML = '<span class="title-icon">‚ö†Ô∏è</span><span>Missing Items Summary</span>';
      
      keys.sort(function(a, b) {
        return (allAreaData[a].area || a).localeCompare(allAreaData[b].area || b);
      });
      
      var html = '';
      for (var k = 0; k < keys.length; k++) {
        var area = allAreaData[keys[k]];
        if (!area || !area.shortages || area.shortages.length === 0) continue;
        
        html += '<div class="area-section"><div class="area-header">';
        html += '<span>' + escapeHtml(area.area || keys[k]) + '</span>';
        html += '<span class="area-count">' + area.shortages.length + ' items</span>';
        html += '</div><ul class="shortage-list">';
        
        for (var s = 0; s < area.shortages.length; s++) {
          var item = area.shortages[s];
          var critical = item.actual === 0;
          
          html += '<li class="shortage-item ' + (critical ? 'critical' : 'warning') + '">';
          html += '<div class="item-info"><span class="item-name">' + escapeHtml(item.name) + '</span>';
          if (item.category) html += '<span class="item-category">' + escapeHtml(item.category) + '</span>';
          html += '</div><div class="item-shortage">';
          html += '<span class="shortage-detail">' + item.actual + ' / ' + item.required + '</span>';
          html += '<span class="shortage-badge' + (critical ? '' : ' warning') + '">' + (critical ? 'MISSING' : 'Need ' + item.shortage) + '</span>';
          html += '</div></li>';
        }
        html += '</ul></div>';
      }
      
      html += '<div class="total-summary"><h4>TOTAL SHORTAGES</h4><div class="total-stats">';
      html += '<div class="total-stat"><span class="stat-number">' + areasShort + '</span><span class="stat-label">Areas</span></div>';
      html += '<div class="total-stat"><span class="stat-number">' + totalShort + '</span><span class="stat-label">Items</span></div>';
      html += '<div class="total-stat"><span class="stat-number">' + totalUnits + '</span><span class="stat-label">Units</span></div>';
      html += '</div></div>';
      
      content.innerHTML = html;
      resizeWidget();
    }
    
    // =====================================================
    // READ FROM PARENT DOM HIDDEN FIELD
    // =====================================================
    
    function pollHiddenField() {
      if (!hiddenFieldId) return;
      
      try {
        var hiddenInput = window.parent.document.getElementById('input_' + hiddenFieldId);
        if (hiddenInput && hiddenInput.value && hiddenInput.value !== lastValue) {
          lastValue = hiddenInput.value;
          debug('Got data: ' + lastValue.substring(0, 80) + '...');
          
          try {
            allAreaData = JSON.parse(lastValue);
            renderSummary();
          } catch(e) {
            debug('Parse error: ' + e);
          }
        }
      } catch(e) {
        debug('DOM access error: ' + e);
      }
    }
    
    function generateReadableOutput() {
      var keys = Object.keys(allAreaData);
      var lines = [];
      var totalShort = 0, totalUnits = 0;
      
      keys.sort(function(a, b) {
        return (allAreaData[a].area || a).localeCompare(allAreaData[b].area || b);
      });
      
      for (var i = 0; i < keys.length; i++) {
        var area = allAreaData[keys[i]];
        if (!area || !area.shortages || area.shortages.length === 0) continue;
        
        if (lines.length > 0) lines.push('');
        lines.push('=== ' + (area.area || keys[i]).toUpperCase() + ' ===');
        
        var byCat = {};
        for (var j = 0; j < area.shortages.length; j++) {
          var item = area.shortages[j];
          var cat = item.category || 'General';
          if (!byCat[cat]) byCat[cat] = [];
          byCat[cat].push(item);
          totalShort++;
          totalUnits += item.shortage;
        }
        
        for (var cat in byCat) {
          lines.push('[' + cat + ']');
          for (var k = 0; k < byCat[cat].length; k++) {
            var item = byCat[cat][k];
            var status = item.actual === 0 
              ? 'MISSING - need ' + item.required
              : 'have ' + item.actual + '/' + item.required + ' - need ' + item.shortage + ' more';
            lines.push('  ‚Ä¢ ' + item.name + ': ' + status);
          }
        }
      }
      
      if (totalShort === 0) return 'ALL ITEMS FULLY STOCKED';
      
      return 'MISSING/SHORT ITEMS REPORT\nGenerated: ' + new Date().toLocaleString() + 
             '\n================================\n\n' + lines.join('\n') +
             '\n\n================================\nSUMMARY: ' + totalShort + ' items (' + totalUnits + ' units needed)';
    }
    
    function resizeWidget() {
      if (typeof JFCustomWidget !== 'undefined') {
        setTimeout(function() {
          JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight + 20 });
        }, 100);
      }
    }
    
    function init() {
      debug('Init');
      
      if (typeof JFCustomWidget !== 'undefined' && JFCustomWidget.subscribe) {
        JFCustomWidget.subscribe("ready", function() {
          hiddenFieldId = JFCustomWidget.getWidgetSetting('hiddenFieldId');
          debug('Ready. hiddenFieldId=' + hiddenFieldId);
          
          if (!hiddenFieldId) {
            document.getElementById('content').innerHTML = 
              '<div class="config-error"><strong>Config needed:</strong> Set hiddenFieldId</div>';
            resizeWidget();
            return;
          }
          
          // Start polling parent DOM
          pollHiddenField();
          pollInterval = setInterval(pollHiddenField, 500);
          resizeWidget();
        });
        
        JFCustomWidget.subscribe("submit", function() {
          if (pollInterval) clearInterval(pollInterval);
          JFCustomWidget.sendSubmit({ valid: true, value: generateReadableOutput() });
        });
      } else {
        debug('No JFCustomWidget - standalone');
        document.getElementById('content').innerHTML = 
          '<div class="no-data"><div class="icon">üìã</div><p>Must run inside JotForm</p></div>';
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
