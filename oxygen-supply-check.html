<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oxygen Supply Check</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    
    .widget-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      max-height: 100vh;
      background: #f5f5f5;
    }
    
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      min-height: 0;
    }
    
    /* Area sections */
    .area-section {
      background: white;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: visible;
    }
    
    .area-header {
      display: flex;
      align-items: center;
      padding: 14px 15px;
      background: #f8f9fa;
      cursor: pointer;
      user-select: none;
      border-bottom: 1px solid #eee;
      gap: 12px;
      border-radius: 8px;
    }
    
    .area-section.expanded .area-header {
      border-radius: 8px 8px 0 0;
    }
    
    .area-header:hover {
      background: #e9ecef;
    }
    
    .area-header.ok {
      background: #d4edda;
      border-left: 4px solid #28a745;
    }
    
    .area-header.low {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
    }
    
    .area-header.unchecked {
      background: #f8f9fa;
      border-left: 4px solid #6c757d;
    }
    
    .collapse-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #666;
      transition: transform 0.2s;
      flex-shrink: 0;
    }
    
    .area-section.expanded .collapse-icon {
      transform: rotate(90deg);
    }
    
    .area-icon {
      font-size: 24px;
      flex-shrink: 0;
    }
    
    .area-info {
      flex: 1;
    }
    
    .area-title {
      font-weight: 600;
      font-size: 15px;
      color: #333;
    }
    
    .area-subtitle {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    
    .area-status {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .area-status.ok {
      background: #28a745;
      color: white;
    }
    
    .area-status.low {
      background: #ffc107;
      color: #333;
    }
    
    .area-status.unchecked {
      background: #6c757d;
      color: white;
    }
    
    .area-content {
      display: none;
      padding: 15px;
      border-top: 1px solid #eee;
    }
    
    .area-section.expanded .area-content {
      display: block;
    }
    
    .area-section.expanded .area-header {
      position: sticky;
      top: 0;
      z-index: 10;
      border-radius: 0;
      margin: 0 -10px;
      width: calc(100% + 20px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Cylinder check */
    .cylinder-item {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .cylinder-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    
    .cylinder-label {
      font-size: 14px;
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .cylinder-label strong {
      color: #0066cc;
    }
    
    /* Check buttons */
    .check-buttons {
      display: flex;
      gap: 10px;
    }
    
    .check-btn {
      flex: 1;
      padding: 16px 12px;
      border: 2px solid #dee2e6;
      border-radius: 12px;
      background: white;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }
    
    .check-btn:hover {
      border-color: #adb5bd;
      background: #f8f9fa;
    }
    
    .check-btn.yes {
      color: #155724;
    }
    
    .check-btn.yes:hover {
      border-color: #28a745;
      background: #d4edda;
    }
    
    .check-btn.yes.selected {
      border-color: #28a745;
      background: #28a745;
      color: white;
    }
    
    .check-btn.no {
      color: #856404;
    }
    
    .check-btn.no:hover {
      border-color: #ffc107;
      background: #fff3cd;
    }
    
    .check-btn.no.selected {
      border-color: #ffc107;
      background: #ffc107;
      color: #333;
    }
    
    .check-btn-icon {
      font-size: 28px;
    }
    
    .check-btn-text {
      font-size: 13px;
    }
    
    /* Summary */
    .summary-bar {
      background: white;
      border-top: 1px solid #ddd;
      padding: 12px 15px;
      display: flex;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .summary-status {
      font-size: 14px;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 20px;
    }
    
    .summary-status.ok {
      background: #d4edda;
      color: #155724;
    }
    
    .summary-status.low {
      background: #fff3cd;
      color: #856404;
    }
    
    .summary-status.unchecked {
      background: #e9ecef;
      color: #495057;
    }
  </style>
</head>
<body>
  <div class="widget-container">
    <div class="main-content" id="mainContent">
      <!-- Areas will be generated here -->
    </div>
    
    <div class="summary-bar">
      <div class="summary-status unchecked" id="summaryStatus">Not Checked</div>
    </div>
  </div>

  <script src="https://cdn.jotfor.ms/s/umd/latest/for-custom-widgets.js"></script>
  <script>
    // =====================================================
    // CONFIGURATION
    // =====================================================
    // Widget Settings:
    //   - mainO2Threshold: Minimum PSI for Main O2 (default: 1500)
    //   - mainO2Cylinders: Number of cylinders in Main O2 (default: 1, max: 2)
    //   - stretcherO2Threshold: Minimum PSI for Stretcher O2 (default: 1000)
    //   - enableMedicalAir: "true" or "false" to show Medical Air section (default: false)
    //   - medicalAirThreshold: Minimum PSI for Medical Air (default: 1500)
    
    var areas = [];
    var areaStates = {}; // areaId -> { cylinders: { 0: bool|null, 1: bool|null } }
    
    // =====================================================
    // BUILD UI
    // =====================================================
    
    function getAreaStatus(areaId) {
      var state = areaStates[areaId];
      if (!state) return 'unchecked';
      
      var area = areas.find(function(a) { return a.id === areaId; });
      if (!area) return 'unchecked';
      
      var allChecked = true;
      var allOk = true;
      
      for (var i = 0; i < area.cylinderCount; i++) {
        if (state.cylinders[i] === null || state.cylinders[i] === undefined) {
          allChecked = false;
        } else if (state.cylinders[i] === false) {
          allOk = false;
        }
      }
      
      if (!allChecked) return 'unchecked';
      if (!allOk) return 'low';
      return 'ok';
    }
    
    function getStatusText(status) {
      if (status === 'ok') return 'OK';
      if (status === 'low') return 'Low';
      return 'Unchecked';
    }
    
    function buildUI() {
      var container = document.getElementById('mainContent');
      container.innerHTML = '';
      
      for (var i = 0; i < areas.length; i++) {
        var area = areas[i];
        
        if (!areaStates[area.id]) {
          areaStates[area.id] = { cylinders: {} };
          for (var c = 0; c < area.cylinderCount; c++) {
            areaStates[area.id].cylinders[c] = null;
          }
        }
        
        var status = getAreaStatus(area.id);
        var statusText = getStatusText(status);
        
        var sectionDiv = document.createElement('div');
        sectionDiv.className = 'area-section';
        sectionDiv.id = 'area_' + area.id;
        
        var subtitleText = 'Min: ' + area.threshold + ' ' + area.unit;
        if (area.cylinderCount > 1) {
          subtitleText += ' Â· ' + area.cylinderCount + ' cylinders';
        }
        
        var headerDiv = document.createElement('div');
        headerDiv.className = 'area-header ' + status;
        headerDiv.innerHTML = 
          '<span class="collapse-icon">â–¶</span>' +
          '<span class="area-icon">' + area.icon + '</span>' +
          '<div class="area-info">' +
            '<div class="area-title">' + escapeHtml(area.name) + '</div>' +
            '<div class="area-subtitle">' + subtitleText + '</div>' +
          '</div>' +
          '<span class="area-status ' + status + '">' + statusText + '</span>';
        
        headerDiv.onclick = (function(div) {
          return function() { toggleArea(div); };
        })(sectionDiv);
        
        var contentDiv = document.createElement('div');
        contentDiv.className = 'area-content';
        
        // Build cylinder checks
        var contentHtml = '';
        for (var c = 0; c < area.cylinderCount; c++) {
          var cylinderState = areaStates[area.id].cylinders[c];
          var cylinderLabel = area.cylinderCount > 1 ? 'Cylinder ' + (c + 1) + ': ' : '';
          
          contentHtml += '<div class="cylinder-item">';
          contentHtml += '<div class="cylinder-label">' + cylinderLabel + 'Above <strong>' + area.threshold + ' ' + area.unit + '</strong>?</div>';
          contentHtml += '<div class="check-buttons">';
          contentHtml += '<button class="check-btn yes' + (cylinderState === true ? ' selected' : '') + '" onclick="setCylinderStatus(\'' + area.id + '\', ' + c + ', true)">';
          contentHtml += '<span class="check-btn-icon">âœ“</span>';
          contentHtml += '<span class="check-btn-text">Yes</span>';
          contentHtml += '</button>';
          contentHtml += '<button class="check-btn no' + (cylinderState === false ? ' selected' : '') + '" onclick="setCylinderStatus(\'' + area.id + '\', ' + c + ', false)">';
          contentHtml += '<span class="check-btn-icon">!</span>';
          contentHtml += '<span class="check-btn-text">No</span>';
          contentHtml += '</button>';
          contentHtml += '</div>';
          contentHtml += '</div>';
        }
        
        contentDiv.innerHTML = contentHtml;
        
        sectionDiv.appendChild(headerDiv);
        sectionDiv.appendChild(contentDiv);
        container.appendChild(sectionDiv);
      }
      
      updateSummary();
    }
    
    // =====================================================
    // INTERACTIONS
    // =====================================================
    
    function toggleArea(areaDiv) {
      var wasExpanded = areaDiv.classList.contains('expanded');
      
      // Close all areas first
      var allAreas = document.querySelectorAll('.area-section');
      for (var i = 0; i < allAreas.length; i++) {
        allAreas[i].classList.remove('expanded');
      }
      
      // If it wasn't expanded, open it
      if (!wasExpanded) {
        areaDiv.classList.add('expanded');
        setTimeout(function() {
          areaDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 50);
      }
    }
    
    function setCylinderStatus(areaId, cylinderIndex, isOk) {
      if (!areaStates[areaId]) {
        areaStates[areaId] = { cylinders: {} };
      }
      areaStates[areaId].cylinders[cylinderIndex] = isOk;
      
      // Update button states
      var sectionDiv = document.getElementById('area_' + areaId);
      if (sectionDiv) {
        var cylinderItems = sectionDiv.querySelectorAll('.cylinder-item');
        if (cylinderItems[cylinderIndex]) {
          var yesBtn = cylinderItems[cylinderIndex].querySelector('.check-btn.yes');
          var noBtn = cylinderItems[cylinderIndex].querySelector('.check-btn.no');
          
          yesBtn.classList.remove('selected');
          noBtn.classList.remove('selected');
          
          if (isOk) {
            yesBtn.classList.add('selected');
          } else {
            noBtn.classList.add('selected');
          }
        }
        
        // Update header status
        var status = getAreaStatus(areaId);
        var statusText = getStatusText(status);
        var headerDiv = sectionDiv.querySelector('.area-header');
        var statusSpan = headerDiv.querySelector('.area-status');
        
        headerDiv.classList.remove('unchecked', 'ok', 'low');
        headerDiv.classList.add(status);
        statusSpan.classList.remove('unchecked', 'ok', 'low');
        statusSpan.classList.add(status);
        statusSpan.textContent = statusText;
      }
      
      updateSummary();
      
      // Check if we should auto-advance
      var area = areas.find(function(a) { return a.id === areaId; });
      if (area) {
        // Check if all cylinders in this area are done
        var allDone = true;
        for (var c = 0; c < area.cylinderCount; c++) {
          if (areaStates[areaId].cylinders[c] === null || areaStates[areaId].cylinders[c] === undefined) {
            allDone = false;
            break;
          }
        }
        
        if (allDone) {
          // Find next unchecked area
          var nextArea = findNextUncheckedArea(areaId);
          if (nextArea) {
            setTimeout(function() {
              var nextSection = document.getElementById('area_' + nextArea);
              if (nextSection) {
                toggleArea(nextSection);
              }
            }, 300);
          } else {
            // All done - close current area
            setTimeout(function() {
              var allAreas = document.querySelectorAll('.area-section');
              for (var i = 0; i < allAreas.length; i++) {
                allAreas[i].classList.remove('expanded');
              }
            }, 300);
          }
        }
      }
    }
    
    function findNextUncheckedArea(currentId) {
      var foundCurrent = false;
      for (var i = 0; i < areas.length; i++) {
        if (areas[i].id === currentId) {
          foundCurrent = true;
          continue;
        }
        if (foundCurrent && getAreaStatus(areas[i].id) === 'unchecked') {
          return areas[i].id;
        }
      }
      // Check from beginning
      for (var j = 0; j < areas.length; j++) {
        if (areas[j].id === currentId) break;
        if (getAreaStatus(areas[j].id) === 'unchecked') {
          return areas[j].id;
        }
      }
      return null;
    }
    
    function updateSummary() {
      var statusEl = document.getElementById('summaryStatus');
      
      var allChecked = true;
      var allOk = true;
      var lowAreas = [];
      
      for (var i = 0; i < areas.length; i++) {
        var status = getAreaStatus(areas[i].id);
        if (status === 'unchecked') {
          allChecked = false;
        } else if (status === 'low') {
          allOk = false;
          lowAreas.push(areas[i].name);
        }
      }
      
      statusEl.classList.remove('ok', 'low', 'unchecked');
      
      if (!allChecked) {
        statusEl.classList.add('unchecked');
        statusEl.textContent = 'Not Checked';
      } else if (allOk) {
        statusEl.classList.add('ok');
        statusEl.textContent = 'âœ“ All OK';
      } else {
        statusEl.classList.add('low');
        statusEl.textContent = '! Low: ' + lowAreas.join(', ');
      }
    }
    
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // =====================================================
    // JOTFORM INTEGRATION
    // =====================================================
    
    function generateSubmitValue() {
      var allChecked = true;
      var allOk = true;
      var lowAreas = [];
      
      for (var i = 0; i < areas.length; i++) {
        var status = getAreaStatus(areas[i].id);
        if (status === 'unchecked') {
          allChecked = false;
        } else if (status === 'low') {
          allOk = false;
          lowAreas.push(areas[i].name);
        }
      }
      
      var output = '';
      if (!allChecked) {
        output = 'Not checked';
      } else if (allOk) {
        output = 'All OK';
      } else {
        output = 'Low: ' + lowAreas.join(', ');
      }
      
      return output;
    }
    
    function resizeWidget() {
      if (typeof JFCustomWidget !== 'undefined') {
        JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight });
      }
    }
    
    // =====================================================
    // INIT
    // =====================================================
    
    function init() {
      if (typeof JFCustomWidget !== 'undefined' && JFCustomWidget.subscribe) {
        JFCustomWidget.subscribe('ready', function(data) {
          console.log('[O2 Widget] Ready', data);
          
          // Build areas from settings
          areas = [];
          
          // Main O2
          var mainO2Threshold = parseInt(JFCustomWidget.getWidgetSetting('mainO2Threshold'), 10) || 1500;
          var mainO2Cylinders = parseInt(JFCustomWidget.getWidgetSetting('mainO2Cylinders'), 10) || 1;
          mainO2Cylinders = Math.max(1, Math.min(2, mainO2Cylinders)); // Clamp 1-2
          
          areas.push({
            id: 'main_o2',
            name: 'Main O2',
            icon: 'ðŸ«',
            threshold: mainO2Threshold,
            unit: 'PSI',
            cylinderCount: mainO2Cylinders
          });
          
          // Stretcher O2
          var stretcherO2Threshold = parseInt(JFCustomWidget.getWidgetSetting('stretcherO2Threshold'), 10) || 1000;
          
          areas.push({
            id: 'stretcher_o2',
            name: 'Stretcher O2',
            icon: 'ðŸ›ï¸',
            threshold: stretcherO2Threshold,
            unit: 'PSI',
            cylinderCount: 1
          });
          
          // Medical Air (optional)
          var enableMedicalAir = JFCustomWidget.getWidgetSetting('enableMedicalAir');
          if (enableMedicalAir === 'true' || enableMedicalAir === true) {
            var medicalAirThreshold = parseInt(JFCustomWidget.getWidgetSetting('medicalAirThreshold'), 10) || 1500;
            
            areas.push({
              id: 'medical_air',
              name: 'Medical Air',
              icon: 'ðŸ’¨',
              threshold: medicalAirThreshold,
              unit: 'PSI',
              cylinderCount: 1
            });
          }
          
          buildUI();
          
          // Restore saved state if editing
          if (data.value) {
            try {
              var saved = JSON.parse(data.value);
              if (saved.areaStates) {
                areaStates = saved.areaStates;
                buildUI();
              }
            } catch (e) {}
          }
          
          resizeWidget();
        });
        
        JFCustomWidget.subscribe('submit', function() {
          JFCustomWidget.sendSubmit({
            valid: true,
            value: generateSubmitValue()
          });
        });
      } else {
        // Standalone mode - use defaults
        areas = [
          { id: 'main_o2', name: 'Main O2', icon: 'ðŸ«', threshold: 1500, unit: 'PSI', cylinderCount: 2 },
          { id: 'stretcher_o2', name: 'Stretcher O2', icon: 'ðŸ›ï¸', threshold: 1000, unit: 'PSI', cylinderCount: 1 },
          { id: 'medical_air', name: 'Medical Air', icon: 'ðŸ’¨', threshold: 1500, unit: 'PSI', cylinderCount: 1 }
        ];
        buildUI();
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
