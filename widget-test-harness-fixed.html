<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Widget Test Harness</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    
    .test-section {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .test-section h2 {
      margin-top: 0;
      color: #0066cc;
      font-size: 16px;
      border-bottom: 2px solid #0066cc;
      padding-bottom: 10px;
    }
    
    .widget-frame {
      width: 100%;
      border: 2px solid #ddd;
      border-radius: 4px;
      min-height: 400px;
    }
    
    .hidden-field-section {
      background: #fff3cd;
      border: 1px solid #ffc107;
    }
    
    .hidden-field {
      width: 100%;
      height: 150px;
      font-family: monospace;
      font-size: 12px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    .controls {
      margin-bottom: 15px;
    }
    
    .controls button {
      background: #0066cc;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    
    .controls button:hover {
      background: #0052a3;
    }
    
    .log-output {
      background: #1e1e1e;
      color: #00ff00;
      font-family: monospace;
      font-size: 12px;
      padding: 15px;
      border-radius: 4px;
      height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    
    .instructions {
      background: #e7f3ff;
      border: 1px solid #b3d7ff;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .instructions h3 {
      margin-top: 0;
      color: #004085;
    }
    
    .instructions ol {
      margin-bottom: 0;
      color: #004085;
    }
  </style>
</head>
<body>
  <h1>üß™ JotForm Widget Test Harness</h1>
  
  <div class="instructions">
    <h3>How to Test:</h3>
    <ol>
      <li>Open this file directly in a browser (all files must be in the same folder)</li>
      <li>Interact with the Area Checklist widgets - check items, change quantities</li>
      <li>Watch the Hidden Field Data update in real-time</li>
      <li>The Missing Items Summary will update automatically</li>
    </ol>
  </div>
  
  <!-- Simulated Hidden Field -->
  <div class="test-section hidden-field-section">
    <h2>üì¶ Hidden Field (Shared Data Store)</h2>
    <p>This simulates the JotForm hidden field that widgets use to communicate:</p>
    <textarea id="input_42" class="hidden-field" placeholder="Widget data will appear here..."></textarea>
    <div class="controls" style="margin-top: 10px;">
      <button onclick="clearHiddenField()">Clear Field</button>
      <button onclick="notifySummaryWidget()">Refresh Summary Widget</button>
    </div>
  </div>
  
  <!-- Area Checklist Widget 1 -->
  <div class="test-section">
    <h2>üöë Area Checklist: Driver Compartment</h2>
    <p>Test the area checklist widget. Check/uncheck items and modify quantities.</p>
    <iframe 
      id="widget1" 
      class="widget-frame" 
      src="area-checklist-widget-fixed.html?area=Driver%20Compartment&widgetId=driver"
      style="height: 600px;">
    </iframe>
  </div>
  
  <!-- Area Checklist Widget 2 -->
  <div class="test-section">
    <h2>üöë Area Checklist: Patient Compartment</h2>
    <iframe 
      id="widget2" 
      class="widget-frame" 
      src="area-checklist-widget-fixed.html?area=Patient%20Compartment&widgetId=patient"
      style="height: 600px;">
    </iframe>
  </div>
  
  <!-- Missing Items Summary Widget -->
  <div class="test-section">
    <h2>üìã Missing Items Summary</h2>
    <p>This widget reads from the hidden field and shows all shortages.</p>
    <iframe 
      id="summaryWidget" 
      class="widget-frame" 
      src="missing-items-widget-fixed.html"
      style="height: 500px;">
    </iframe>
  </div>
  
  <!-- Console Log -->
  <div class="test-section">
    <h2>üñ•Ô∏è Console Log</h2>
    <div class="controls">
      <button onclick="clearLog()">Clear Log</button>
      <button onclick="testSubmit()">Simulate Form Submit</button>
    </div>
    <div id="logOutput" class="log-output">Ready for testing...\n</div>
  </div>

  <script>
    // Shared data store (simulates hidden field)
    var sharedData = {};
    
    // Listen for messages from child widgets
    window.addEventListener('message', function(event) {
      // In production, you'd validate event.origin
      
      if (event.data && event.data.type === 'widgetData') {
        appendLog('Received data from widget: ' + event.data.widgetId);
        
        // Store the data
        sharedData[event.data.widgetId] = event.data.payload;
        
        // Update the hidden field display
        document.getElementById('input_42').value = JSON.stringify(sharedData, null, 2);
        
        // Notify the summary widget
        notifySummaryWidget();
      }
    });
    
    function notifySummaryWidget() {
      var summaryFrame = document.getElementById('summaryWidget');
      if (summaryFrame && summaryFrame.contentWindow) {
        summaryFrame.contentWindow.postMessage({
          type: 'updateData',
          payload: sharedData
        }, '*');
        appendLog('Notified summary widget of data update');
      }
    }
    
    function appendLog(message) {
      var log = document.getElementById('logOutput');
      var timestamp = new Date().toLocaleTimeString();
      log.textContent += '[' + timestamp + '] ' + message + '\n';
      log.scrollTop = log.scrollHeight;
    }
    
    function clearLog() {
      document.getElementById('logOutput').textContent = 'Log cleared.\n';
    }
    
    function clearHiddenField() {
      sharedData = {};
      document.getElementById('input_42').value = '';
      notifySummaryWidget();
      appendLog('Hidden field cleared');
    }
    
    function testSubmit() {
      appendLog('=== SIMULATING FORM SUBMIT ===');
      
      if (Object.keys(sharedData).length > 0) {
        appendLog('Submit data: ' + JSON.stringify(sharedData, null, 2));
      } else {
        appendLog('No data to submit');
      }
    }
    
    appendLog('Test harness loaded. Using postMessage for cross-frame communication.');
  </script>
</body>
</html>
