<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Area Checklist Widget</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    body {
      margin: 0;
      padding: 10px;
      background: #fff;
    }
    
    .widget-title {
      font-size: 16px;
      font-weight: 700;
      color: #0066cc;
      margin: 0 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 3px solid #0066cc;
    }
    
    .checklist-container {
      max-width: 100%;
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin: 15px 0 10px 0;
      padding-bottom: 5px;
      border-bottom: 2px solid #ccc;
    }
    
    .section-title:first-child {
      margin-top: 0;
    }
    
    .checklist-items {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .checklist-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 2px solid transparent;
      transition: all 0.15s;
    }
    
    .checklist-item:hover {
      background: #e9ecef;
    }
    
    .checklist-item.checked {
      background: #d4edda;
      border-color: #28a745;
    }
    
    .checklist-item.short {
      background: #fff3cd;
      border-color: #ffc107;
    }
    
    .checklist-item.missing {
      background: #f8d7da;
      border-color: #dc3545;
    }
    
    .checklist-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      cursor: pointer;
      accent-color: #28a745;
      flex-shrink: 0;
    }
    
    .item-name {
      flex: 1;
      font-size: 14px;
      color: #333;
      font-weight: 500;
    }
    
    .item-quantities {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-shrink: 0;
    }
    
    .quantity-group {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 13px;
    }
    
    .quantity-label {
      color: #666;
    }
    
    .required-amount {
      font-weight: 600;
      color: #0066cc;
      min-width: 30px;
      text-align: center;
    }
    
    .actual-input {
      width: 60px;
      padding: 5px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      text-align: center;
    }
    
    .actual-input:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2);
    }
    
    .shortage-badge {
      background: #dc3545;
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 10px;
      margin-left: 10px;
    }
    
    .summary-bar {
      margin-top: 20px;
      padding: 12px 15px;
      background: #e9ecef;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      font-size: 13px;
    }
    
    .summary-stat {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .stat-ok { color: #28a745; }
    .stat-short { color: #ffc107; }
    .stat-missing { color: #dc3545; }
    
    .instructions {
      background: #e7f3ff;
      border: 1px solid #b3d7ff;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 15px;
      font-size: 13px;
      color: #004085;
    }
    
    .no-items {
      padding: 20px;
      text-align: center;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div id="widgetTitle" class="widget-title">Area Checklist</div>
  
  <div class="instructions">
    ✓ Check the box if item is fully stocked<br>
    ✗ Leave unchecked and enter actual quantity if item is short or missing
  </div>
  
  <div class="checklist-container" id="checklistContainer">
    <div class="no-items">Loading checklist items...</div>
  </div>
  
  <div class="summary-bar" id="summaryBar">
    <span class="summary-stat stat-ok">✓ OK: <strong id="okCount">0</strong></span>
    <span class="summary-stat stat-short">⚠ Short: <strong id="shortCount">0</strong></span>
    <span class="summary-stat stat-missing">✗ Missing: <strong id="missingCount">0</strong></span>
  </div>

  <script>
    // =====================================================
    // INVENTORY CONFIGURATIONS FOR DIFFERENT AREAS
    // =====================================================
    
    var INVENTORY_CONFIGS = {
      'Driver Compartment': [
        "Equipment",
        "Flashlight|2",
        "Maps/GPS Unit|1",
        "Radio|1",
        "Clipboard|1",
        "",
        "Safety",
        "Reflective Vest|2",
        "Traffic Cones|4",
        "Flares|6"
      ].join("\n"),
      
      'Patient Compartment': [
        "Medical Supplies",
        "Bandages|10",
        "Gauze Pads|20",
        "Alcohol Wipes|30",
        "Tape Rolls|5",
        "",
        "PPE",
        "Gloves (pairs)|50",
        "Face Masks|20",
        "Eye Protection|4",
        "",
        "Equipment",
        "Stethoscope|2",
        "Blood Pressure Cuff|2",
        "Pulse Oximeter|2"
      ].join("\n")
    };
    
    var DEFAULT_INVENTORY = INVENTORY_CONFIGS['Driver Compartment'];
    
    // =====================================================
    // WIDGET STATE
    // =====================================================
    
    var areaName = "Area Checklist";
    var inventory = [];  // Array of {category, name, required}
    var itemStates = {}; // {itemKey: {checked: bool, actual: number}}
    var widgetId = null;
    
    // =====================================================
    // GET URL PARAMETERS (for standalone testing)
    // =====================================================
    
    function getUrlParams() {
      var params = {};
      var search = window.location.search.substring(1);
      if (search) {
        var pairs = search.split('&');
        for (var i = 0; i < pairs.length; i++) {
          var pair = pairs[i].split('=');
          params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
        }
      }
      return params;
    }
    
    // =====================================================
    // PARSE INVENTORY FROM SETTINGS
    // =====================================================
    
    function parseInventory(text) {
      var lines = text.split("\n");
      var items = [];
      var currentCategory = "Items";
      
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        
        if (!line) continue;
        
        // Check if it's a category header [Category Name] or just Category Name
        if (line.charAt(0) === '[' && line.charAt(line.length - 1) === ']') {
          currentCategory = line.substring(1, line.length - 1).trim();
        } else if (line.indexOf('|') === -1 && lines[i + 1] && lines[i + 1].indexOf('|') !== -1) {
          // Line without | followed by line with | = category header
          currentCategory = line;
        } else if (line.indexOf('|') !== -1) {
          // Item line: Name|RequiredQty
          var parts = line.split('|');
          var itemName = parts[0].trim();
          var required = parseInt(parts[1], 10) || 1;
          
          items.push({
            category: currentCategory,
            name: itemName,
            required: required,
            key: currentCategory + '::' + itemName
          });
        } else {
          // Line without | and not followed by items = category
          currentCategory = line;
        }
      }
      
      return items;
    }
    
    // =====================================================
    // BUILD CHECKLIST UI
    // =====================================================
    
    function buildChecklist() {
      var container = document.getElementById('checklistContainer');
      if (!container) return;
      
      if (inventory.length === 0) {
        container.innerHTML = '<div class="no-items">No checklist items configured.<br>Add items in Widget Settings.</div>';
        return;
      }
      
      container.innerHTML = '';
      var currentCategory = null;
      var itemsDiv = null;
      
      for (var i = 0; i < inventory.length; i++) {
        var item = inventory[i];
        
        // New category
        if (item.category !== currentCategory) {
          currentCategory = item.category;
          
          var titleDiv = document.createElement('div');
          titleDiv.className = 'section-title';
          titleDiv.textContent = currentCategory;
          container.appendChild(titleDiv);
          
          itemsDiv = document.createElement('div');
          itemsDiv.className = 'checklist-items';
          container.appendChild(itemsDiv);
        }
        
        // Initialize state if not exists
        if (!itemStates[item.key]) {
          itemStates[item.key] = { checked: false, actual: 0 };
        }
        
        var state = itemStates[item.key];
        
        // Create item row
        var itemDiv = document.createElement('div');
        itemDiv.className = 'checklist-item';
        itemDiv.setAttribute('data-key', item.key);
        updateItemClass(itemDiv, state, item.required);
        
        // Checkbox
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = state.checked;
        checkbox.id = 'cb_' + i;
        
        // Item name
        var nameSpan = document.createElement('span');
        nameSpan.className = 'item-name';
        nameSpan.textContent = item.name;
        
        // Quantities container
        var qtyDiv = document.createElement('div');
        qtyDiv.className = 'item-quantities';
        
        // Required amount
        var reqGroup = document.createElement('div');
        reqGroup.className = 'quantity-group';
        var reqLabel = document.createElement('span');
        reqLabel.className = 'quantity-label';
        reqLabel.textContent = 'Req:';
        var reqAmount = document.createElement('span');
        reqAmount.className = 'required-amount';
        reqAmount.textContent = item.required;
        reqGroup.appendChild(reqLabel);
        reqGroup.appendChild(reqAmount);
        
        // Actual amount input
        var actGroup = document.createElement('div');
        actGroup.className = 'quantity-group';
        var actLabel = document.createElement('span');
        actLabel.className = 'quantity-label';
        actLabel.textContent = 'Actual:';
        var actInput = document.createElement('input');
        actInput.type = 'number';
        actInput.className = 'actual-input';
        actInput.min = '0';
        actInput.max = '9999';
        actInput.value = state.checked ? item.required : state.actual;
        actInput.id = 'act_' + i;
        actGroup.appendChild(actLabel);
        actGroup.appendChild(actInput);
        
        // Shortage badge (hidden initially)
        var badge = document.createElement('span');
        badge.className = 'shortage-badge';
        badge.id = 'badge_' + i;
        badge.style.display = 'none';
        
        qtyDiv.appendChild(reqGroup);
        qtyDiv.appendChild(actGroup);
        qtyDiv.appendChild(badge);
        
        itemDiv.appendChild(checkbox);
        itemDiv.appendChild(nameSpan);
        itemDiv.appendChild(qtyDiv);
        
        itemsDiv.appendChild(itemDiv);
        
        // Event listeners
        (function(key, required, cb, input, div, badgeEl) {
          cb.addEventListener('change', function() {
            if (cb.checked) {
              input.value = required;
              itemStates[key] = { checked: true, actual: required };
            } else {
              itemStates[key].checked = false;
            }
            updateItemClass(div, itemStates[key], required);
            updateBadge(badgeEl, itemStates[key], required);
            updateSummary();
            broadcastData();
          });
          
          input.addEventListener('input', function() {
            var val = parseInt(input.value, 10) || 0;
            itemStates[key].actual = val;
            
            if (val >= required) {
              cb.checked = true;
              itemStates[key].checked = true;
            } else {
              cb.checked = false;
              itemStates[key].checked = false;
            }
            
            updateItemClass(div, itemStates[key], required);
            updateBadge(badgeEl, itemStates[key], required);
            updateSummary();
            broadcastData();
          });
          
          // Initialize badge
          updateBadge(badgeEl, itemStates[key], required);
        })(item.key, item.required, checkbox, actInput, itemDiv, badge);
      }
      
      updateSummary();
      // Broadcast initial state
      broadcastData();
    }
    
    function updateItemClass(div, state, required) {
      div.classList.remove('checked', 'short', 'missing');
      
      if (state.checked && state.actual >= required) {
        div.classList.add('checked');
      } else if (state.actual > 0 && state.actual < required) {
        div.classList.add('short');
      } else if (!state.checked && state.actual === 0) {
        div.classList.add('missing');
      }
    }
    
    function updateBadge(badge, state, required) {
      if (state.checked && state.actual >= required) {
        badge.style.display = 'none';
      } else {
        var shortage = required - (state.actual || 0);
        badge.textContent = '-' + shortage;
        badge.style.display = 'inline';
      }
    }
    
    function updateSummary() {
      var ok = 0, short = 0, missing = 0;
      
      for (var i = 0; i < inventory.length; i++) {
        var item = inventory[i];
        var state = itemStates[item.key];
        
        if (state && state.checked && state.actual >= item.required) {
          ok++;
        } else if (state && state.actual > 0 && state.actual < item.required) {
          short++;
        } else {
          missing++;
        }
      }
      
      document.getElementById('okCount').textContent = ok;
      document.getElementById('shortCount').textContent = short;
      document.getElementById('missingCount').textContent = missing;
    }
    
    // =====================================================
    // BROADCAST DATA VIA POSTMESSAGE
    // =====================================================
    
    function broadcastData() {
      var shortages = [];
      
      for (var i = 0; i < inventory.length; i++) {
        var item = inventory[i];
        var state = itemStates[item.key] || { checked: false, actual: 0 };
        
        if (!state.checked || state.actual < item.required) {
          var shortage = item.required - (state.actual || 0);
          shortages.push({
            area: areaName,
            category: item.category,
            name: item.name,
            required: item.required,
            actual: state.actual || 0,
            shortage: shortage
          });
        }
      }
      
      var data = {
        area: areaName,
        shortages: shortages,
        timestamp: new Date().toISOString()
      };
      
      // Send to parent via postMessage (for standalone testing)
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'widgetData',
          widgetId: widgetId,
          payload: data
        }, '*');
      }
      
      // Also try JotForm API if available
      if (typeof JFCustomWidget !== 'undefined') {
        JFCustomWidget.sendData({
          value: JSON.stringify(data)
        });
      }
    }
    
    // =====================================================
    // RESIZE WIDGET
    // =====================================================
    
    function resizeWidget() {
      if (typeof JFCustomWidget === 'undefined') return;
      
      setTimeout(function() {
        var height = document.body.scrollHeight + 20;
        JFCustomWidget.requestFrameResize({ height: height });
      }, 100);
    }
    
    // =====================================================
    // INITIALIZATION
    // =====================================================
    
    var jotformReady = false;
    
    function initStandalone() {
      if (jotformReady) return;
      
      console.log("Running in standalone/test mode");
      
      // Get settings from URL params
      var params = getUrlParams();
      areaName = params.area || 'Area Checklist';
      widgetId = params.widgetId || areaName;
      
      // Use area-specific inventory if available
      var inventoryText = INVENTORY_CONFIGS[areaName] || DEFAULT_INVENTORY;
      
      document.getElementById('widgetTitle').textContent = areaName;
      inventory = parseInventory(inventoryText);
      buildChecklist();
    }
    
    function init() {
      // Set a timeout - if JotForm doesn't respond in 500ms, run standalone
      var fallbackTimer = setTimeout(function() {
        if (!jotformReady) {
          initStandalone();
        }
      }, 500);
      
      // Try to get settings from JotForm
      if (typeof JFCustomWidget !== 'undefined' && JFCustomWidget.subscribe) {
        JFCustomWidget.subscribe("ready", function(data) {
          jotformReady = true;
          clearTimeout(fallbackTimer);
          
          // Get widget settings
          areaName = JFCustomWidget.getWidgetSetting('areaName') || 'Area Checklist';
          var inventoryText = JFCustomWidget.getWidgetSetting('inventoryItems') || DEFAULT_INVENTORY;
          widgetId = JFCustomWidget.getWidgetSetting('widgetId') || areaName;
          
          document.getElementById('widgetTitle').textContent = areaName;
          inventory = parseInventory(inventoryText);
          
          // Restore saved state if editing
          if (data.value) {
            try {
              var saved = JSON.parse(data.value);
              if (saved.shortages) {
                for (var i = 0; i < inventory.length; i++) {
                  var item = inventory[i];
                  var found = false;
                  for (var j = 0; j < saved.shortages.length; j++) {
                    if (saved.shortages[j].name === item.name) {
                      itemStates[item.key] = {
                        checked: false,
                        actual: saved.shortages[j].actual
                      };
                      found = true;
                      break;
                    }
                  }
                  if (!found) {
                    itemStates[item.key] = { checked: true, actual: item.required };
                  }
                }
              }
            } catch (e) {
              console.log("Could not parse saved data:", e);
            }
          }
          
          buildChecklist();
          resizeWidget();
        });
        
        JFCustomWidget.subscribe("submit", function() {
          var shortages = [];
          
          for (var i = 0; i < inventory.length; i++) {
            var item = inventory[i];
            var state = itemStates[item.key] || { checked: false, actual: 0 };
            
            if (!state.checked || state.actual < item.required) {
              shortages.push({
                area: areaName,
                category: item.category,
                name: item.name,
                required: item.required,
                actual: state.actual || 0,
                shortage: item.required - (state.actual || 0)
              });
            }
          }
          
          var data = {
            widgetId: widgetId,
            area: areaName,
            shortages: shortages,
            timestamp: new Date().toISOString()
          };
          
          JFCustomWidget.sendSubmit({
            valid: true,
            value: JSON.stringify(data)
          });
        });
      } else {
        clearTimeout(fallbackTimer);
        initStandalone();
      }
    }
    
    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
  
  <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
</body>
</html>
