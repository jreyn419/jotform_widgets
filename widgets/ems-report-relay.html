<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EMS Report Relay</title>
<script src="https://cdn.jotfor.ms/s/umd/latest/for-custom-widgets.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Courier New', Courier, monospace;
    font-size: 11px;
    background: #fafafa;
    color: #333;
  }
  #status {
    padding: 6px 10px;
    font-size: 11px;
    color: #888;
    font-style: italic;
  }
  #status.connected {
    color: #2a7d2a;
    font-style: normal;
  }
  #report {
    width: 100%;
    max-height: 300px;
    overflow-y: auto;
    padding: 8px 10px;
    font-family: 'Courier New', Courier, monospace;
    font-size: 11px;
    line-height: 1.4;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    color: #333;
  }
</style>
</head>
<body>
<div id="status">Waiting for checklist data…</div>
<div id="report"></div>

<script>
(function() {
  var VERSION = '1.2.1';
  var report = '';
  var htmlReport = '';
  var cachedFormID = null;

  // Parse formID from URL params or ready callback
  function getFormID() {
    try {
      var match = window.location.href.match(/[?&]formID=([^&]+)/);
      if (match) return match[1];
    } catch (e) {}
    return null;
  }

  function getRelayKey() {
    var formID = cachedFormID || getFormID() || 'unknown';
    return 'ems_report_relay_' + formID;
  }

  function readReport() {
    try {
      var raw = localStorage.getItem(getRelayKey());
      if (!raw) return null;
      var data = JSON.parse(raw);
      return {
        text: data.report || null,
        html: data.htmlReport || null
      };
    } catch (e) {
      return null;
    }
  }

  function updateDisplay(data) {
    var el = document.getElementById('report');
    var statusEl = document.getElementById('status');
    if (data && (data.html || data.text)) {
      if (data.html) {
        el.innerHTML = data.html;
        htmlReport = data.html;
      } else {
        el.textContent = data.text;
      }
      report = data.text || '';
      statusEl.textContent = 'Report received (v' + VERSION + ')';
      statusEl.className = 'connected';

      // Push plain text via sendData so JotForm Tables displays
      // the report inline without needing the widget iframe to render.
      if (typeof JFCustomWidget !== 'undefined' && JFCustomWidget.sendData) {
        try {
          JFCustomWidget.sendData({ value: report });
        } catch (e) {}
      }
    } else {
      el.textContent = '';
      statusEl.textContent = 'Waiting for checklist data…';
      statusEl.className = '';
    }
    resizeWidget();
  }

  function resizeWidget() {
    try {
      var height = document.body.scrollHeight + 10;
      if (typeof JFCustomWidget !== 'undefined' && JFCustomWidget.requestFrameResize) {
        JFCustomWidget.requestFrameResize({ height: height });
      }
    } catch (e) {}
  }

  // Listen for storage events from the checklist widget (same origin)
  window.addEventListener('storage', function(e) {
    if (e.key === getRelayKey() && e.newValue) {
      try {
        var data = JSON.parse(e.newValue);
        updateDisplay({ text: data.report, html: data.htmlReport });
      } catch (err) {}
    }
  });

  // Poll as fallback — storage event doesn't fire for writes from
  // the same page/tab, and iframe behavior can be inconsistent.
  var lastTimestamp = 0;
  var pollInterval = setInterval(function() {
    try {
      var raw = localStorage.getItem(getRelayKey());
      if (!raw) return;
      var data = JSON.parse(raw);
      if (data.timestamp && data.timestamp > lastTimestamp) {
        lastTimestamp = data.timestamp;
        updateDisplay({ text: data.report, html: data.htmlReport });
      }
    } catch (e) {}
  }, 1500);

  // JotForm widget lifecycle
  if (typeof JFCustomWidget !== 'undefined') {
    JFCustomWidget.subscribe('ready', function(data) {
      cachedFormID = (data && data.formID) || getFormID();
      console.log('[ReportRelay] Ready, formID=' + cachedFormID + ', key=' + getRelayKey());

      // Restore from submitted value if editing a submission
      if (data && data.value) {
        var restoredText = data.value;

        // Handle legacy JSON-wrapped values from pre-1.2.0 submissions
        try {
          var parsed = JSON.parse(data.value);
          if (parsed && parsed.report) {
            restoredText = parsed.report;
          }
        } catch (e) {
          // Not JSON — it's already plain text (1.2.0+ format)
        }

        report = restoredText;
        var el = document.getElementById('report');
        el.textContent = restoredText;
        document.getElementById('status').textContent = 'Report loaded from submission';
        document.getElementById('status').className = 'connected';

        // Tell Tables our display value so it appears in the cell
        try {
          JFCustomWidget.sendData({ value: restoredText });
        } catch (e) {}

        resizeWidget();
      } else {
        // Check for existing report from current session
        var reportData = readReport();
        if (reportData) updateDisplay(reportData);
      }

      JFCustomWidget.subscribe('submit', function() {
        var finalData = readReport();
        var finalText = (finalData && finalData.text) || report || '';
        console.log('[ReportRelay] Submitting report (' + finalText.length + ' chars)');
        JFCustomWidget.sendSubmit({
          valid: true,
          value: finalText
        });
      });
    });
  } else {
    // Standalone / testing mode
    var reportData = readReport();
    if (reportData) updateDisplay(reportData);
  }
})();
</script>
</body>
</html>
