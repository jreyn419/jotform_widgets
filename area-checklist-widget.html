<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Area Checklist Widget</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    body {
      margin: 0;
      padding: 10px;
      background: #fff;
    }
    
    .widget-title {
      font-size: 16px;
      font-weight: 700;
      color: #0066cc;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 3px solid #0066cc;
    }
    
    .checklist-container {
      max-width: 100%;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 12px 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 2px solid #ccc;
    }
    
    .section-header:first-child {
      margin-top: 0;
    }
    
    .section-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #28a745;
      flex-shrink: 0;
    }
    
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      flex: 1;
    }
    
    .section-status {
      font-size: 11px;
      color: #666;
      font-weight: normal;
    }
    
    .checklist-items {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .checklist-item {
      display: grid;
      grid-template-columns: 28px 1fr;
      grid-template-rows: auto auto;
      align-items: center;
      gap: 4px 8px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid transparent;
      transition: all 0.15s;
    }
    
    .checklist-item:hover {
      background: #e9ecef;
    }
    
    .checklist-item.checked {
      background: #d4edda;
      border-left-color: #28a745;
    }
    
    .checklist-item.short {
      background: #fff3cd;
      border-left-color: #ffc107;
    }
    
    .checklist-item.missing {
      background: #f8d7da;
      border-left-color: #dc3545;
    }
    
    .checklist-item input[type="checkbox"] {
      grid-column: 1;
      grid-row: 1 / 3;
      width: 24px;
      height: 24px;
      margin: 0;
      cursor: pointer;
      accent-color: #28a745;
      align-self: start;
      margin-top: 2px;
    }
    
    .item-name-row {
      grid-column: 2;
      grid-row: 1;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }
    
    .item-name {
      font-size: 14px;
      color: #333;
      font-weight: 500;
      line-height: 1.3;
      flex: 1;
    }
    
    .shortage-badge {
      background: #dc3545;
      color: white;
      font-size: 12px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
      visibility: hidden;
      flex-shrink: 0;
    }
    
    .shortage-badge.visible {
      visibility: visible;
    }
    
    .shortage-badge.warning {
      background: #ffc107;
      color: #333;
    }
    
    .item-quantities {
      grid-column: 2;
      grid-row: 2;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }
    
    .req-display {
      font-size: 12px;
      color: #666;
    }
    
    .req-display strong {
      color: #0066cc;
      font-weight: 600;
    }
    
    .qty-stepper {
      display: flex;
      align-items: center;
      gap: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .qty-btn {
      width: 44px;
      height: 44px;
      border: none;
      background: #f0f0f0;
      color: #333;
      font-size: 22px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      transition: background 0.1s;
    }
    
    .qty-btn:hover {
      background: #e0e0e0;
    }
    
    .qty-btn:active {
      background: #d0d0d0;
    }
    
    .qty-btn.decrement {
      border-right: 1px solid #ccc;
    }
    
    .qty-btn.increment {
      border-left: 1px solid #ccc;
    }
    
    .qty-value {
      width: 50px;
      height: 44px;
      border: none;
      background: #fff;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      color: #333;
      -moz-appearance: textfield;
    }
    
    .qty-value::-webkit-outer-spin-button,
    .qty-value::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    .qty-value:focus {
      outline: none;
      background: #f8f9fa;
    }
    
    .summary-bar {
      margin-top: 15px;
      padding: 10px 12px;
      background: #e9ecef;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }
    
    .summary-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .stat-ok { color: #28a745; }
    .stat-short { color: #856404; }
    .stat-missing { color: #dc3545; }
    
    .instructions {
      background: #e7f3ff;
      border: 1px solid #b3d7ff;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 12px;
      font-size: 12px;
      color: #004085;
      line-height: 1.4;
    }
    
    .no-items {
      padding: 20px;
      text-align: center;
      color: #666;
      font-style: italic;
    }
    
    .config-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 6px;
      padding: 15px;
      color: #721c24;
      font-size: 13px;
      margin-bottom: 12px;
    }

    @media (min-width: 500px) {
      .checklist-item {
        grid-template-columns: 28px 1fr auto auto;
        grid-template-rows: auto;
        padding: 10px 12px;
      }
      
      .checklist-item input[type="checkbox"] {
        grid-row: 1;
        align-self: center;
        margin-top: 0;
      }
      
      .item-name-row {
        grid-column: 2;
        display: block;
      }
      
      .shortage-badge {
        position: absolute;
      }
      
      .item-quantities {
        grid-column: 3;
        grid-row: 1;
        margin-top: 0;
        gap: 15px;
      }
      
      .qty-btn {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }
      
      .qty-value {
        width: 45px;
        height: 40px;
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <div id="widgetTitle" class="widget-title">Area Checklist</div>
  <div id="configError" class="config-error" style="display: none;"></div>
  
  <div class="instructions">
    ✓ Check = fully stocked &nbsp;|&nbsp; Use − + to adjust quantity
  </div>
  
  <div class="checklist-container" id="checklistContainer">
    <div class="no-items">Loading checklist items...</div>
  </div>
  
  <div class="summary-bar">
    <span class="summary-stat stat-ok">✓ OK: <strong id="okCount">0</strong></span>
    <span class="summary-stat stat-short">⚠ Short: <strong id="shortCount">0</strong></span>
    <span class="summary-stat stat-missing">✗ Missing: <strong id="missingCount">0</strong></span>
  </div>

  <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
  <script>
    var DEFAULT_INVENTORY = [
      "Equipment",
      "Flashlight|2",
      "Radio|1",
      "",
      "Supplies",
      "Bandages|10",
      "Gloves (pairs)|50"
    ].join("\n");
    
    var areaName = "Area Checklist";
    var widgetId = null;
    var hiddenFieldId = null;
    var inventory = [];
    var itemStates = {};
    var broadcastTimer = null;
    var categoryElements = {};
    
    function parseInventory(text) {
      var lines = text.split("\n");
      var items = [];
      var currentCategory = "Items";
      
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;
        
        if (line.indexOf('|') === -1) {
          currentCategory = line.replace(/^\[|\]$/g, '');
        } else {
          var parts = line.split('|');
          items.push({
            category: currentCategory,
            name: parts[0].trim(),
            required: parseInt(parts[1], 10) || 1,
            key: currentCategory + '::' + parts[0].trim()
          });
        }
      }
      return items;
    }
    
    function buildChecklist() {
      var container = document.getElementById('checklistContainer');
      if (inventory.length === 0) {
        container.innerHTML = '<div class="no-items">No items configured.</div>';
        return;
      }
      
      container.innerHTML = '';
      categoryElements = {};
      var currentCategory = null;
      var itemsDiv = null;
      
      for (var i = 0; i < inventory.length; i++) {
        var item = inventory[i];
        
        if (item.category !== currentCategory) {
          currentCategory = item.category;
          
          var header = document.createElement('div');
          header.className = 'section-header';
          
          var sectionCb = document.createElement('input');
          sectionCb.type = 'checkbox';
          sectionCb.className = 'section-checkbox';
          
          var title = document.createElement('span');
          title.className = 'section-title';
          title.textContent = currentCategory;
          
          var status = document.createElement('span');
          status.className = 'section-status';
          
          header.appendChild(sectionCb);
          header.appendChild(title);
          header.appendChild(status);
          container.appendChild(header);
          
          itemsDiv = document.createElement('div');
          itemsDiv.className = 'checklist-items';
          container.appendChild(itemsDiv);
          
          categoryElements[currentCategory] = {
            checkbox: sectionCb,
            statusEl: status,
            items: []
          };
          
          (function(cat, cb) {
            cb.addEventListener('change', function() {
              selectAllInCategory(cat, cb.checked);
            });
          })(currentCategory, sectionCb);
        }
        
        if (!itemStates[item.key]) {
          itemStates[item.key] = { actual: 0 };
        }
        
        var state = itemStates[item.key];
        var row = document.createElement('div');
        row.className = 'checklist-item';
        updateItemClass(row, state.actual, item.required);
        
        var cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = state.actual >= item.required;
        
        var nameRow = document.createElement('div');
        nameRow.className = 'item-name-row';
        
        var name = document.createElement('span');
        name.className = 'item-name';
        name.textContent = item.name;
        
        var badge = document.createElement('span');
        badge.className = 'shortage-badge';
        updateBadge(badge, state.actual, item.required);
        
        nameRow.appendChild(name);
        nameRow.appendChild(badge);
        
        var qtyDiv = document.createElement('div');
        qtyDiv.className = 'item-quantities';
        
        var req = document.createElement('span');
        req.className = 'req-display';
        req.innerHTML = 'Need: <strong>' + item.required + '</strong>';
        
        var stepper = document.createElement('div');
        stepper.className = 'qty-stepper';
        
        var decBtn = document.createElement('button');
        decBtn.type = 'button';
        decBtn.className = 'qty-btn decrement';
        decBtn.textContent = '−';
        
        var input = document.createElement('input');
        input.type = 'number';
        input.className = 'qty-value';
        input.min = '0';
        input.value = state.actual;
        
        var incBtn = document.createElement('button');
        incBtn.type = 'button';
        incBtn.className = 'qty-btn increment';
        incBtn.textContent = '+';
        
        stepper.appendChild(decBtn);
        stepper.appendChild(input);
        stepper.appendChild(incBtn);
        qtyDiv.appendChild(req);
        qtyDiv.appendChild(stepper);
        
        row.appendChild(cb);
        row.appendChild(nameRow);
        row.appendChild(qtyDiv);
        itemsDiv.appendChild(row);
        
        categoryElements[item.category].items.push({
          item: item,
          checkbox: cb,
          input: input,
          row: row,
          badge: badge
        });
        
        (function(key, required, checkbox, valueInput, rowEl, badgeEl, cat) {
          function setVal(v) {
            v = Math.max(0, Math.min(9999, v));
            itemStates[key] = { actual: v };
            checkbox.checked = v >= required;
            valueInput.value = v;
            updateItemClass(rowEl, v, required);
            updateBadge(badgeEl, v, required);
            updateSummary();
            updateCategoryState(cat);
            broadcastDebounced();
          }
          
          checkbox.addEventListener('change', function() {
            setVal(checkbox.checked ? required : 0);
          });
          
          valueInput.addEventListener('input', function() {
            setVal(parseInt(valueInput.value, 10) || 0);
          });
          
          decBtn.addEventListener('click', function(e) {
            e.preventDefault();
            setVal((parseInt(valueInput.value, 10) || 0) - 1);
          });
          
          incBtn.addEventListener('click', function(e) {
            e.preventDefault();
            setVal((parseInt(valueInput.value, 10) || 0) + 1);
          });
        })(item.key, item.required, cb, input, row, badge, item.category);
      }
      
      updateSummary();
      for (var cat in categoryElements) updateCategoryState(cat);
    }
    
    function selectAllInCategory(cat, checked) {
      var els = categoryElements[cat];
      if (!els) return;
      
      for (var i = 0; i < els.items.length; i++) {
        var el = els.items[i];
        var v = checked ? el.item.required : 0;
        itemStates[el.item.key] = { actual: v };
        el.checkbox.checked = checked;
        el.input.value = v;
        updateItemClass(el.row, v, el.item.required);
        updateBadge(el.badge, v, el.item.required);
      }
      updateSummary();
      updateCategoryState(cat);
      broadcastDebounced();
    }
    
    function updateCategoryState(cat) {
      var els = categoryElements[cat];
      if (!els) return;
      
      var allOk = true, noneOk = true, okCount = 0;
      for (var i = 0; i < els.items.length; i++) {
        var actual = itemStates[els.items[i].item.key].actual;
        var required = els.items[i].item.required;
        if (actual >= required) { noneOk = false; okCount++; }
        else allOk = false;
      }
      
      els.checkbox.checked = allOk;
      els.checkbox.indeterminate = !allOk && !noneOk;
      els.statusEl.textContent = '(' + okCount + '/' + els.items.length + ')';
    }
    
    function updateItemClass(el, actual, required) {
      el.classList.remove('checked', 'short', 'missing');
      if (actual >= required) el.classList.add('checked');
      else if (actual > 0) el.classList.add('short');
      else el.classList.add('missing');
    }
    
    function updateBadge(el, actual, required) {
      if (actual >= required) {
        el.classList.remove('visible', 'warning');
        el.textContent = '';
      } else {
        el.textContent = '-' + (required - actual);
        el.classList.add('visible');
        el.classList.toggle('warning', actual > 0);
      }
    }
    
    function updateSummary() {
      var ok = 0, short = 0, missing = 0;
      for (var i = 0; i < inventory.length; i++) {
        var actual = (itemStates[inventory[i].key] || {actual:0}).actual;
        if (actual >= inventory[i].required) ok++;
        else if (actual > 0) short++;
        else missing++;
      }
      document.getElementById('okCount').textContent = ok;
      document.getElementById('shortCount').textContent = short;
      document.getElementById('missingCount').textContent = missing;
    }
    
    // =====================================================
    // BROADCAST TO HIDDEN FIELD VIA PARENT DOM
    // =====================================================
    
    function broadcastDebounced() {
      if (broadcastTimer) clearTimeout(broadcastTimer);
      broadcastTimer = setTimeout(broadcastData, 150);
    }
    
    function broadcastData() {
      if (!hiddenFieldId || !widgetId) return;
      
      var shortages = [];
      for (var i = 0; i < inventory.length; i++) {
        var item = inventory[i];
        var actual = (itemStates[item.key] || {actual:0}).actual;
        if (actual < item.required) {
          shortages.push({
            area: areaName,
            category: item.category,
            name: item.name,
            required: item.required,
            actual: actual,
            shortage: item.required - actual
          });
        }
      }
      
      var myData = {
        widgetId: widgetId,
        area: areaName,
        shortages: shortages,
        timestamp: Date.now()
      };
      
      // Try to write directly to parent's hidden field
      try {
        var hiddenInput = window.parent.document.getElementById('input_' + hiddenFieldId);
        if (hiddenInput) {
          var allData = {};
          if (hiddenInput.value) {
            try { allData = JSON.parse(hiddenInput.value); } catch(e) {}
          }
          allData[widgetId] = myData;
          hiddenInput.value = JSON.stringify(allData);
          
          // Trigger change event so JotForm knows
          var evt = document.createEvent('HTMLEvents');
          evt.initEvent('change', true, false);
          hiddenInput.dispatchEvent(evt);
        }
      } catch(e) {
        console.log('Could not access parent hidden field:', e);
      }
    }
    
    function resizeWidget() {
      if (typeof JFCustomWidget !== 'undefined') {
        setTimeout(function() {
          JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight + 20 });
        }, 100);
      }
    }
    
    // =====================================================
    // INIT
    // =====================================================
    
    function init() {
      if (typeof JFCustomWidget !== 'undefined' && JFCustomWidget.subscribe) {
        JFCustomWidget.subscribe("ready", function(data) {
          areaName = JFCustomWidget.getWidgetSetting('areaName') || 'Area Checklist';
          widgetId = JFCustomWidget.getWidgetSetting('widgetId') || areaName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
          hiddenFieldId = JFCustomWidget.getWidgetSetting('hiddenFieldId') || null;
          var inventoryText = JFCustomWidget.getWidgetSetting('inventoryItems') || DEFAULT_INVENTORY;
          
          document.getElementById('widgetTitle').textContent = areaName;
          
          if (!hiddenFieldId) {
            document.getElementById('configError').style.display = 'block';
            document.getElementById('configError').textContent = 'Set hiddenFieldId in widget settings';
          }
          
          inventory = parseInventory(inventoryText);
          
          // Restore from saved data
          if (data.value) {
            try {
              var saved = JSON.parse(data.value);
              if (saved.shortages) {
                for (var i = 0; i < inventory.length; i++) {
                  itemStates[inventory[i].key] = { actual: inventory[i].required };
                }
                for (var j = 0; j < saved.shortages.length; j++) {
                  var s = saved.shortages[j];
                  for (var k = 0; k < inventory.length; k++) {
                    if (inventory[k].name === s.name) {
                      itemStates[inventory[k].key] = { actual: s.actual || 0 };
                      break;
                    }
                  }
                }
              }
            } catch(e) {}
          }
          
          buildChecklist();
          resizeWidget();
          broadcastData();
        });
        
        JFCustomWidget.subscribe("submit", function() {
          JFCustomWidget.sendSubmit({ valid: true, value: '' });
        });
      } else {
        // Standalone mode
        document.getElementById('widgetTitle').textContent = 'Area Checklist (Test)';
        inventory = parseInventory(DEFAULT_INVENTORY);
        buildChecklist();
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
