<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Area Checklist Widget</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    body {
      margin: 0;
      padding: 10px;
      background: #fff;
    }
    
    .widget-title {
      font-size: 16px;
      font-weight: 700;
      color: #0066cc;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 3px solid #0066cc;
    }
    
    .checklist-container {
      max-width: 100%;
    }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 12px 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 2px solid #ccc;
    }
    
    .section-header:first-child {
      margin-top: 0;
    }
    
    .section-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: #28a745;
      flex-shrink: 0;
    }
    
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      flex: 1;
    }
    
    .section-status {
      font-size: 11px;
      color: #666;
      font-weight: normal;
    }
    
    .checklist-items {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .checklist-item {
      display: grid;
      grid-template-columns: 28px 1fr;
      grid-template-rows: auto auto auto;
      align-items: center;
      gap: 4px 8px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid transparent;
      transition: all 0.15s;
    }
    
    .checklist-item:hover {
      background: #e9ecef;
    }
    
    .checklist-item.checked {
      background: #d4edda;
      border-left-color: #28a745;
    }
    
    .checklist-item.short {
      background: #fff3cd;
      border-left-color: #ffc107;
    }
    
    .checklist-item.missing {
      background: #f8d7da;
      border-left-color: #dc3545;
    }
    
    .checklist-item input[type="checkbox"] {
      grid-column: 1;
      grid-row: 1 / 4;
      width: 24px;
      height: 24px;
      margin: 0;
      cursor: pointer;
      accent-color: #28a745;
      align-self: start;
      margin-top: 2px;
    }
    
    .item-name-row {
      grid-column: 2;
      grid-row: 1;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }
    
    .item-name {
      font-size: 14px;
      color: #333;
      font-weight: 500;
      line-height: 1.3;
      flex: 1;
    }
    
    .shortage-badge {
      background: #dc3545;
      color: white;
      font-size: 12px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 4px;
      white-space: nowrap;
      visibility: hidden;
      flex-shrink: 0;
    }
    
    .shortage-badge.visible {
      visibility: visible;
    }
    
    .shortage-badge.warning {
      background: #ffc107;
      color: #333;
    }
    
    .item-quantities {
      grid-column: 2;
      grid-row: 2;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 4px;
    }
    
    .req-display {
      font-size: 12px;
      color: #666;
    }
    
    .req-display strong {
      color: #0066cc;
      font-weight: 600;
    }
    
    .qty-stepper {
      display: flex;
      align-items: center;
      gap: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 6px;
      overflow: hidden;
    }
    
    .qty-btn {
      width: 44px;
      height: 44px;
      border: none;
      background: #f0f0f0;
      color: #333;
      font-size: 22px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-user-select: none;
      touch-action: manipulation;
      transition: background 0.1s;
    }
    
    .qty-btn:hover {
      background: #e0e0e0;
    }
    
    .qty-btn:active {
      background: #d0d0d0;
    }
    
    .qty-btn.decrement {
      border-right: 1px solid #ccc;
    }
    
    .qty-btn.increment {
      border-left: 1px solid #ccc;
    }
    
    .qty-value {
      width: 50px;
      height: 44px;
      border: none;
      background: #fff;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      color: #333;
      -moz-appearance: textfield;
    }
    
    .qty-value::-webkit-outer-spin-button,
    .qty-value::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    .qty-value:focus {
      outline: none;
      background: #f8f9fa;
    }
    
    .summary-bar {
      margin-top: 15px;
      padding: 10px 12px;
      background: #e9ecef;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }
    
    .summary-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .stat-ok { color: #28a745; }
    .stat-short { color: #856404; }
    .stat-missing { color: #dc3545; }
    
    .instructions {
      background: #e7f3ff;
      border: 1px solid #b3d7ff;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 12px;
      font-size: 12px;
      color: #004085;
      line-height: 1.4;
    }
    
    .no-items {
      padding: 20px;
      text-align: center;
      color: #666;
      font-style: italic;
    }
    
    .config-error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 6px;
      padding: 15px;
      color: #721c24;
      font-size: 13px;
      margin-bottom: 12px;
    }

    @media (min-width: 500px) {
      .checklist-item {
        grid-template-columns: 28px 1fr auto auto;
        grid-template-rows: auto;
        padding: 10px 12px;
      }
      
      .checklist-item input[type="checkbox"] {
        grid-row: 1;
        align-self: center;
        margin-top: 0;
      }
      
      .item-name-row {
        grid-column: 2;
        display: block;
      }
      
      .item-name {
        display: block;
      }
      
      .shortage-badge {
        position: absolute;
      }
      
      .item-quantities {
        grid-column: 3;
        grid-row: 1;
        margin-top: 0;
        gap: 15px;
      }
      
      .badge-cell {
        grid-column: 4;
        grid-row: 1;
      }
      
      .qty-btn {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }
      
      .qty-value {
        width: 45px;
        height: 40px;
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <div id="widgetTitle" class="widget-title">Area Checklist</div>
  
  <div id="configError" class="config-error" style="display: none;"></div>
  
  <div class="instructions">
    âœ“ Check = fully stocked &nbsp;|&nbsp; Use âˆ’ + to adjust quantity
  </div>
  
  <div class="checklist-container" id="checklistContainer">
    <div class="no-items">Loading checklist items...</div>
  </div>
  
  <div class="summary-bar" id="summaryBar">
    <span class="summary-stat stat-ok">âœ“ OK: <strong id="okCount">0</strong></span>
    <span class="summary-stat stat-short">âš  Short: <strong id="shortCount">0</strong></span>
    <span class="summary-stat stat-missing">âœ— Missing: <strong id="missingCount">0</strong></span>
  </div>

  <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
  <script>
    // =====================================================
    // CONFIGURATION
    // =====================================================
    // Widget Settings needed:
    //   - areaName: Display name for this area (e.g., "Driver Compartment")
    //   - widgetId: Unique ID for this widget (e.g., "driver" or "area1")
    //   - hiddenFieldId: Field ID of the shared hidden field (e.g., "42")
    //   - inventoryItems: The inventory list in format "Category\nItem|Qty"
    
    var DEFAULT_INVENTORY = [
      "Driver Compartment",
      "Flashlight|2",
      "Maps/GPS Unit|1",
      "Radio|1",
      "Clipboard|1",
      "",
      "Main Supplies",
      "Bandages|10",
      "Gauze Pads|20",
      "Gloves (pairs)|50",
      "Alcohol Wipes|30"
    ].join("\n");
    
    // =====================================================
    // WIDGET STATE
    // =====================================================
    
    var areaName = "Area Checklist";
    var widgetId = null;
    var hiddenFieldId = null;
    var inventory = [];
    var itemStates = {};
    var broadcastDebounceTimer = null;
    
    var categoryItems = {};
    var categoryElements = {};
    
    // =====================================================
    // PARSE INVENTORY
    // =====================================================
    
    function parseInventory(text) {
      var lines = text.split("\n");
      var items = [];
      var currentCategory = "Items";
      
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;
        
        if (line.charAt(0) === '[' && line.charAt(line.length - 1) === ']') {
          currentCategory = line.substring(1, line.length - 1).trim();
        } else if (line.indexOf('|') === -1 && lines[i + 1] && lines[i + 1].indexOf('|') !== -1) {
          currentCategory = line;
        } else if (line.indexOf('|') !== -1) {
          var parts = line.split('|');
          items.push({
            category: currentCategory,
            name: parts[0].trim(),
            required: parseInt(parts[1], 10) || 1,
            key: currentCategory + '::' + parts[0].trim()
          });
        } else {
          currentCategory = line;
        }
      }
      return items;
    }
    
    // =====================================================
    // BUILD UI
    // =====================================================
    
    function buildChecklist() {
      var container = document.getElementById('checklistContainer');
      if (!container) return;
      
      if (inventory.length === 0) {
        container.innerHTML = '<div class="no-items">No checklist items configured.</div>';
        return;
      }
      
      container.innerHTML = '';
      categoryItems = {};
      categoryElements = {};
      
      var currentCategory = null;
      var itemsDiv = null;
      
      for (var i = 0; i < inventory.length; i++) {
        var item = inventory[i];
        
        if (!categoryItems[item.category]) {
          categoryItems[item.category] = [];
        }
        categoryItems[item.category].push(item);
        
        if (item.category !== currentCategory) {
          currentCategory = item.category;
          
          var headerDiv = document.createElement('div');
          headerDiv.className = 'section-header';
          
          var sectionCheckbox = document.createElement('input');
          sectionCheckbox.type = 'checkbox';
          sectionCheckbox.className = 'section-checkbox';
          
          var titleSpan = document.createElement('span');
          titleSpan.className = 'section-title';
          titleSpan.textContent = currentCategory;
          
          var statusSpan = document.createElement('span');
          statusSpan.className = 'section-status';
          
          headerDiv.appendChild(sectionCheckbox);
          headerDiv.appendChild(titleSpan);
          headerDiv.appendChild(statusSpan);
          container.appendChild(headerDiv);
          
          itemsDiv = document.createElement('div');
          itemsDiv.className = 'checklist-items';
          container.appendChild(itemsDiv);
          
          categoryElements[currentCategory] = {
            checkbox: sectionCheckbox,
            statusEl: statusSpan,
            itemElements: []
          };
          
          (function(catName, catCheckbox) {
            catCheckbox.addEventListener('change', function() {
              selectAllInCategory(catName, catCheckbox.checked);
            });
          })(currentCategory, sectionCheckbox);
        }
        
        if (!itemStates[item.key]) {
          itemStates[item.key] = { actual: 0 };
        }
        
        var state = itemStates[item.key];
        
        var itemDiv = document.createElement('div');
        itemDiv.className = 'checklist-item';
        updateItemClass(itemDiv, state.actual, item.required);
        
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = state.actual >= item.required;
        
        var nameRow = document.createElement('div');
        nameRow.className = 'item-name-row';
        
        var nameSpan = document.createElement('span');
        nameSpan.className = 'item-name';
        nameSpan.textContent = item.name;
        
        var badge = document.createElement('span');
        badge.className = 'shortage-badge';
        updateBadge(badge, state.actual, item.required);
        
        nameRow.appendChild(nameSpan);
        nameRow.appendChild(badge);
        
        var qtyDiv = document.createElement('div');
        qtyDiv.className = 'item-quantities';
        
        var reqDisplay = document.createElement('span');
        reqDisplay.className = 'req-display';
        reqDisplay.innerHTML = 'Need: <strong>' + item.required + '</strong>';
        
        var stepper = document.createElement('div');
        stepper.className = 'qty-stepper';
        
        var decBtn = document.createElement('button');
        decBtn.type = 'button';
        decBtn.className = 'qty-btn decrement';
        decBtn.textContent = 'âˆ’';
        
        var valueInput = document.createElement('input');
        valueInput.type = 'number';
        valueInput.className = 'qty-value';
        valueInput.min = '0';
        valueInput.value = state.actual;
        
        var incBtn = document.createElement('button');
        incBtn.type = 'button';
        incBtn.className = 'qty-btn increment';
        incBtn.textContent = '+';
        
        stepper.appendChild(decBtn);
        stepper.appendChild(valueInput);
        stepper.appendChild(incBtn);
        
        qtyDiv.appendChild(reqDisplay);
        qtyDiv.appendChild(stepper);
        
        itemDiv.appendChild(checkbox);
        itemDiv.appendChild(nameRow);
        itemDiv.appendChild(qtyDiv);
        
        itemsDiv.appendChild(itemDiv);
        
        categoryElements[item.category].itemElements.push({
          item: item,
          checkbox: checkbox,
          valueInput: valueInput,
          itemDiv: itemDiv,
          badge: badge
        });
        
        (function(key, required, cb, input, div, badgeEl, decB, incB, catName) {
          function setVal(val) {
            val = Math.max(0, Math.min(9999, val));
            itemStates[key] = { actual: val };
            cb.checked = val >= required;
            input.value = val;
            updateItemClass(div, val, required);
            updateBadge(badgeEl, val, required);
            updateSummary();
            updateCategoryCheckbox(catName);
            broadcastDebounced();
          }
          
          cb.addEventListener('change', function() {
            setVal(cb.checked ? required : 0);
          });
          
          input.addEventListener('input', function() {
            setVal(parseInt(input.value, 10) || 0);
          });
          
          decB.addEventListener('click', function(e) {
            e.preventDefault();
            setVal((parseInt(input.value, 10) || 0) - 1);
          });
          
          incB.addEventListener('click', function(e) {
            e.preventDefault();
            setVal((parseInt(input.value, 10) || 0) + 1);
          });
        })(item.key, item.required, checkbox, valueInput, itemDiv, badge, decBtn, incBtn, item.category);
      }
      
      updateSummary();
      updateAllCategoryCheckboxes();
    }
    
    function selectAllInCategory(catName, checked) {
      var catEl = categoryElements[catName];
      if (!catEl) return;
      
      for (var i = 0; i < catEl.itemElements.length; i++) {
        var el = catEl.itemElements[i];
        var val = checked ? el.item.required : 0;
        itemStates[el.item.key] = { actual: val };
        el.checkbox.checked = checked;
        el.valueInput.value = val;
        updateItemClass(el.itemDiv, val, el.item.required);
        updateBadge(el.badge, val, el.item.required);
      }
      
      updateSummary();
      updateCategoryStatus(catName);
      broadcastDebounced();
    }
    
    function updateCategoryCheckbox(catName) {
      var catEl = categoryElements[catName];
      if (!catEl) return;
      
      var allOk = true, noneOk = true;
      for (var i = 0; i < catEl.itemElements.length; i++) {
        var el = catEl.itemElements[i];
        var actual = itemStates[el.item.key].actual;
        if (actual >= el.item.required) noneOk = false;
        else allOk = false;
      }
      
      catEl.checkbox.checked = allOk;
      catEl.checkbox.indeterminate = !allOk && !noneOk;
      updateCategoryStatus(catName);
    }
    
    function updateCategoryStatus(catName) {
      var catEl = categoryElements[catName];
      if (!catEl) return;
      
      var ok = 0;
      for (var i = 0; i < catEl.itemElements.length; i++) {
        var el = catEl.itemElements[i];
        if (itemStates[el.item.key].actual >= el.item.required) ok++;
      }
      catEl.statusEl.textContent = '(' + ok + '/' + catEl.itemElements.length + ')';
    }
    
    function updateAllCategoryCheckboxes() {
      for (var cat in categoryElements) {
        updateCategoryCheckbox(cat);
      }
    }
    
    function updateItemClass(div, actual, required) {
      div.classList.remove('checked', 'short', 'missing');
      if (actual >= required) div.classList.add('checked');
      else if (actual > 0) div.classList.add('short');
      else div.classList.add('missing');
    }
    
    function updateBadge(badge, actual, required) {
      if (actual >= required) {
        badge.classList.remove('visible', 'warning');
        badge.textContent = '';
      } else {
        badge.textContent = '-' + (required - actual);
        badge.classList.add('visible');
        badge.classList.toggle('warning', actual > 0);
      }
    }
    
    function updateSummary() {
      var ok = 0, short = 0, missing = 0;
      for (var i = 0; i < inventory.length; i++) {
        var item = inventory[i];
        var actual = (itemStates[item.key] || { actual: 0 }).actual;
        if (actual >= item.required) ok++;
        else if (actual > 0) short++;
        else missing++;
      }
      document.getElementById('okCount').textContent = ok;
      document.getElementById('shortCount').textContent = short;
      document.getElementById('missingCount').textContent = missing;
    }
    
    // =====================================================
    // BROADCAST TO HIDDEN FIELD
    // =====================================================
    
    function broadcastDebounced() {
      if (broadcastDebounceTimer) clearTimeout(broadcastDebounceTimer);
      broadcastDebounceTimer = setTimeout(broadcastData, 150);
    }
    
    function broadcastData() {
      if (!hiddenFieldId || typeof JFCustomWidget === 'undefined') return;
      
      // Build this area's shortage data
      var shortages = [];
      for (var i = 0; i < inventory.length; i++) {
        var item = inventory[i];
        var actual = (itemStates[item.key] || { actual: 0 }).actual;
        if (actual < item.required) {
          shortages.push({
            area: areaName,
            category: item.category,
            name: item.name,
            required: item.required,
            actual: actual,
            shortage: item.required - actual
          });
        }
      }
      
      var myData = {
        widgetId: widgetId,
        area: areaName,
        shortages: shortages,
        timestamp: Date.now()
      };
      
      // Read existing data from hidden field, merge, and write back
      var allData = {};
      try {
        var existingValue = JFCustomWidget.getFieldValue(hiddenFieldId);
        if (existingValue) {
          allData = JSON.parse(existingValue);
        }
      } catch (e) {
        console.log('Error reading hidden field:', e);
      }
      
      allData[widgetId] = myData;
      
      try {
        JFCustomWidget.setFieldValue(hiddenFieldId, JSON.stringify(allData));
      } catch (e) {
        console.log('Error writing to hidden field:', e);
      }
    }
    
    // =====================================================
    // RESIZE
    // =====================================================
    
    function resizeWidget() {
      if (typeof JFCustomWidget === 'undefined') return;
      setTimeout(function() {
        JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight + 20 });
      }, 100);
    }
    
    // =====================================================
    // INIT
    // =====================================================
    
    var jotformReady = false;
    
    function initStandalone() {
      if (jotformReady) return;
      document.getElementById('widgetTitle').textContent = "Area Checklist (Test Mode)";
      inventory = parseInventory(DEFAULT_INVENTORY);
      buildChecklist();
    }
    
    function init() {
      var fallback = setTimeout(function() {
        if (!jotformReady) initStandalone();
      }, 1000);
      
      if (typeof JFCustomWidget !== 'undefined' && JFCustomWidget.subscribe) {
        JFCustomWidget.subscribe("ready", function(data) {
          jotformReady = true;
          clearTimeout(fallback);
          
          areaName = JFCustomWidget.getWidgetSetting('areaName') || 'Area Checklist';
          widgetId = JFCustomWidget.getWidgetSetting('widgetId') || areaName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
          hiddenFieldId = JFCustomWidget.getWidgetSetting('hiddenFieldId') || null;
          var inventoryText = JFCustomWidget.getWidgetSetting('inventoryItems') || DEFAULT_INVENTORY;
          
          document.getElementById('widgetTitle').textContent = areaName;
          
          if (!hiddenFieldId) {
            document.getElementById('configError').style.display = 'block';
            document.getElementById('configError').innerHTML = 
              '<strong>Configuration needed:</strong> Set <code>hiddenFieldId</code> in widget settings ' +
              'to the field ID of your hidden field (e.g., "42").';
          }
          
          inventory = parseInventory(inventoryText);
          
          // Restore state if editing
          if (data.value) {
            try {
              var saved = JSON.parse(data.value);
              if (saved.shortages) {
                // Mark all as stocked first
                for (var i = 0; i < inventory.length; i++) {
                  itemStates[inventory[i].key] = { actual: inventory[i].required };
                }
                // Then apply shortages
                for (var j = 0; j < saved.shortages.length; j++) {
                  var s = saved.shortages[j];
                  for (var k = 0; k < inventory.length; k++) {
                    if (inventory[k].name === s.name && inventory[k].category === s.category) {
                      itemStates[inventory[k].key] = { actual: s.actual || 0 };
                      break;
                    }
                  }
                }
              }
            } catch (e) {}
          }
          
          buildChecklist();
          resizeWidget();
          broadcastData();
        });
        
        JFCustomWidget.subscribe("submit", function() {
          // Don't output anything - summary widget handles it
          JFCustomWidget.sendSubmit({ valid: true, value: '' });
        });
      } else {
        clearTimeout(fallback);
        initStandalone();
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
