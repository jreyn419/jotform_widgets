<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Area Checklist Widget</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    
    body {
      margin: 0;
      padding: 10px;
      background: #fff;
    }
    
    .widget-title {
      font-size: 16px;
      font-weight: 700;
      color: #0066cc;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 3px solid #0066cc;
    }
    
    .checklist-container {
      max-width: 100%;
    }
    
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: #333;
      margin: 12px 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 2px solid #ccc;
    }
    
    .section-title:first-child {
      margin-top: 0;
    }
    
    .checklist-items {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    /* ===== CHECKLIST ITEM - MOBILE FIRST ===== */
    .checklist-item {
      display: grid;
      grid-template-columns: 28px 1fr auto;
      grid-template-rows: auto auto;
      align-items: center;
      gap: 0 8px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid transparent;
      transition: all 0.15s;
    }
    
    .checklist-item:hover {
      background: #e9ecef;
    }
    
    .checklist-item.checked {
      background: #d4edda;
      border-left-color: #28a745;
    }
    
    .checklist-item.short {
      background: #fff3cd;
      border-left-color: #ffc107;
    }
    
    .checklist-item.missing {
      background: #f8d7da;
      border-left-color: #dc3545;
    }
    
    /* Checkbox - spans both rows on mobile */
    .checklist-item input[type="checkbox"] {
      grid-row: 1 / 3;
      width: 22px;
      height: 22px;
      margin: 0;
      cursor: pointer;
      accent-color: #28a745;
    }
    
    /* Item name */
    .item-name {
      grid-column: 2;
      grid-row: 1;
      font-size: 14px;
      color: #333;
      font-weight: 500;
      line-height: 1.3;
    }
    
    /* Shortage badge - fixed position, always visible space reserved */
    .shortage-badge {
      grid-column: 3;
      grid-row: 1 / 3;
      background: #dc3545;
      color: white;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: 4px;
      min-width: 45px;
      text-align: center;
      visibility: hidden; /* Hidden but space reserved */
    }
    
    .shortage-badge.visible {
      visibility: visible;
    }
    
    .shortage-badge.warning {
      background: #ffc107;
      color: #333;
    }
    
    /* Quantities row */
    .item-quantities {
      grid-column: 2;
      grid-row: 2;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 6px;
    }
    
    .quantity-group {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
    }
    
    .quantity-label {
      color: #666;
    }
    
    .required-amount {
      font-weight: 600;
      color: #0066cc;
    }
    
    .actual-input {
      width: 52px;
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      text-align: center;
    }
    
    .actual-input:focus {
      outline: none;
      border-color: #0066cc;
      box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2);
    }
    
    /* ===== SUMMARY BAR ===== */
    .summary-bar {
      margin-top: 15px;
      padding: 10px 12px;
      background: #e9ecef;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      font-size: 12px;
    }
    
    .summary-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .stat-ok { color: #28a745; }
    .stat-short { color: #856404; }
    .stat-missing { color: #dc3545; }
    
    .instructions {
      background: #e7f3ff;
      border: 1px solid #b3d7ff;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 12px;
      font-size: 12px;
      color: #004085;
      line-height: 1.4;
    }
    
    .no-items {
      padding: 20px;
      text-align: center;
      color: #666;
      font-style: italic;
    }
    
    /* ===== DESKTOP STYLES ===== */
    @media (min-width: 480px) {
      .checklist-item {
        grid-template-columns: 28px 1fr auto auto;
        grid-template-rows: auto;
        padding: 10px 12px;
      }
      
      .checklist-item input[type="checkbox"] {
        grid-row: 1;
      }
      
      .item-name {
        grid-column: 2;
      }
      
      .item-quantities {
        grid-column: 3;
        grid-row: 1;
        margin-top: 0;
        gap: 15px;
      }
      
      .shortage-badge {
        grid-column: 4;
        grid-row: 1;
      }
      
      .quantity-group {
        font-size: 13px;
      }
      
      .actual-input {
        width: 60px;
      }
    }
  </style>
</head>
<body>
  <div id="widgetTitle" class="widget-title">Area Checklist</div>
  
  <div class="instructions">
    ✓ Check = fully stocked &nbsp;|&nbsp; ✗ Unchecked = enter actual qty
  </div>
  
  <div class="checklist-container" id="checklistContainer">
    <div class="no-items">Loading checklist items...</div>
  </div>
  
  <div class="summary-bar" id="summaryBar">
    <span class="summary-stat stat-ok">✓ OK: <strong id="okCount">0</strong></span>
    <span class="summary-stat stat-short">⚠ Short: <strong id="shortCount">0</strong></span>
    <span class="summary-stat stat-missing">✗ Missing: <strong id="missingCount">0</strong></span>
  </div>

  <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
  <script>
    // =====================================================
    // DEFAULT INVENTORY (used for standalone testing)
    // =====================================================
    
    var DEFAULT_INVENTORY = [
      "Driver Compartment",
      "Flashlight|2",
      "Maps/GPS Unit|1",
      "Radio|1",
      "Clipboard|1",
      "",
      "Main Supplies",
      "Bandages|10",
      "Gauze Pads|20",
      "Gloves (pairs)|50",
      "Alcohol Wipes|30"
    ].join("\n");
    
    // =====================================================
    // WIDGET STATE
    // =====================================================
    
    var areaName = "Area Checklist";
    var inventory = [];
    var itemStates = {};
    var summaryFieldId = null;
    var widgetId = null;
    var broadcastDebounceTimer = null;
    
    // =====================================================
    // PARSE INVENTORY FROM SETTINGS
    // =====================================================
    
    function parseInventory(text) {
      var lines = text.split("\n");
      var items = [];
      var currentCategory = "Items";
      
      for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        
        if (!line) continue;
        
        if (line.charAt(0) === '[' && line.charAt(line.length - 1) === ']') {
          currentCategory = line.substring(1, line.length - 1).trim();
        } else if (line.indexOf('|') === -1 && lines[i + 1] && lines[i + 1].indexOf('|') !== -1) {
          currentCategory = line;
        } else if (line.indexOf('|') !== -1) {
          var parts = line.split('|');
          var itemName = parts[0].trim();
          var required = parseInt(parts[1], 10) || 1;
          
          items.push({
            category: currentCategory,
            name: itemName,
            required: required,
            key: currentCategory + '::' + itemName
          });
        } else {
          currentCategory = line;
        }
      }
      
      return items;
    }
    
    // =====================================================
    // BUILD CHECKLIST UI
    // =====================================================
    
    function buildChecklist() {
      var container = document.getElementById('checklistContainer');
      if (!container) return;
      
      if (inventory.length === 0) {
        container.innerHTML = '<div class="no-items">No checklist items configured.<br>Add items in Widget Settings.</div>';
        return;
      }
      
      container.innerHTML = '';
      var currentCategory = null;
      var itemsDiv = null;
      
      for (var i = 0; i < inventory.length; i++) {
        var item = inventory[i];
        
        if (item.category !== currentCategory) {
          currentCategory = item.category;
          
          var titleDiv = document.createElement('div');
          titleDiv.className = 'section-title';
          titleDiv.textContent = currentCategory;
          container.appendChild(titleDiv);
          
          itemsDiv = document.createElement('div');
          itemsDiv.className = 'checklist-items';
          container.appendChild(itemsDiv);
        }
        
        if (!itemStates[item.key]) {
          itemStates[item.key] = { checked: false, actual: 0 };
        }
        
        var state = itemStates[item.key];
        
        // Create item row
        var itemDiv = document.createElement('div');
        itemDiv.className = 'checklist-item';
        itemDiv.setAttribute('data-key', item.key);
        updateItemClass(itemDiv, state, item.required);
        
        // Checkbox
        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = state.checked;
        checkbox.id = 'cb_' + i;
        
        // Item name
        var nameSpan = document.createElement('span');
        nameSpan.className = 'item-name';
        nameSpan.textContent = item.name;
        
        // Quantities container
        var qtyDiv = document.createElement('div');
        qtyDiv.className = 'item-quantities';
        
        // Required amount
        var reqGroup = document.createElement('div');
        reqGroup.className = 'quantity-group';
        var reqLabel = document.createElement('span');
        reqLabel.className = 'quantity-label';
        reqLabel.textContent = 'Req:';
        var reqAmount = document.createElement('span');
        reqAmount.className = 'required-amount';
        reqAmount.textContent = item.required;
        reqGroup.appendChild(reqLabel);
        reqGroup.appendChild(reqAmount);
        
        // Actual amount input
        var actGroup = document.createElement('div');
        actGroup.className = 'quantity-group';
        var actLabel = document.createElement('span');
        actLabel.className = 'quantity-label';
        actLabel.textContent = 'Actual:';
        var actInput = document.createElement('input');
        actInput.type = 'number';
        actInput.className = 'actual-input';
        actInput.min = '0';
        actInput.max = '9999';
        actInput.value = state.checked ? item.required : state.actual;
        actInput.id = 'act_' + i;
        actGroup.appendChild(actLabel);
        actGroup.appendChild(actInput);
        
        qtyDiv.appendChild(reqGroup);
        qtyDiv.appendChild(actGroup);
        
        // Shortage badge - always present, visibility toggled
        var badge = document.createElement('span');
        badge.className = 'shortage-badge';
        badge.id = 'badge_' + i;
        updateBadge(badge, state, item.required);
        
        // Append in grid order
        itemDiv.appendChild(checkbox);
        itemDiv.appendChild(nameSpan);
        itemDiv.appendChild(qtyDiv);
        itemDiv.appendChild(badge);
        
        itemsDiv.appendChild(itemDiv);
        
        // Event listeners
        (function(key, required, cb, input, div, badgeEl) {
          cb.addEventListener('change', function() {
            if (cb.checked) {
              input.value = required;
              itemStates[key] = { checked: true, actual: required };
            } else {
              itemStates[key].checked = false;
            }
            updateItemClass(div, itemStates[key], required);
            updateBadge(badgeEl, itemStates[key], required);
            updateSummary();
            broadcastDataDebounced();
          });
          
          input.addEventListener('input', function() {
            var val = parseInt(input.value, 10) || 0;
            itemStates[key].actual = val;
            
            if (val >= required) {
              cb.checked = true;
              itemStates[key].checked = true;
            } else {
              cb.checked = false;
              itemStates[key].checked = false;
            }
            
            updateItemClass(div, itemStates[key], required);
            updateBadge(badgeEl, itemStates[key], required);
            updateSummary();
            broadcastDataDebounced();
          });
        })(item.key, item.required, checkbox, actInput, itemDiv, badge);
      }
      
      updateSummary();
    }
    
    function updateItemClass(div, state, required) {
      div.classList.remove('checked', 'short', 'missing');
      
      if (state.checked && state.actual >= required) {
        div.classList.add('checked');
      } else if (state.actual > 0 && state.actual < required) {
        div.classList.add('short');
      } else if (!state.checked && state.actual === 0) {
        div.classList.add('missing');
      }
    }
    
    function updateBadge(badge, state, required) {
      if (state.checked && state.actual >= required) {
        badge.classList.remove('visible', 'warning');
        badge.textContent = '';
      } else {
        var shortage = required - (state.actual || 0);
        badge.textContent = '-' + shortage;
        badge.classList.add('visible');
        
        if (state.actual > 0) {
          badge.classList.add('warning');
        } else {
          badge.classList.remove('warning');
        }
      }
    }
    
    function updateSummary() {
      var ok = 0, short = 0, missing = 0;
      
      for (var i = 0; i < inventory.length; i++) {
        var item = inventory[i];
        var state = itemStates[item.key];
        
        if (state && state.checked && state.actual >= item.required) {
          ok++;
        } else if (state && state.actual > 0 && state.actual < item.required) {
          short++;
        } else {
          missing++;
        }
      }
      
      document.getElementById('okCount').textContent = ok;
      document.getElementById('shortCount').textContent = short;
      document.getElementById('missingCount').textContent = missing;
    }
    
    // =====================================================
    // BROADCAST DATA VIA JOTFORM API
    // =====================================================
    
    function broadcastDataDebounced() {
      if (broadcastDebounceTimer) {
        clearTimeout(broadcastDebounceTimer);
      }
      broadcastDebounceTimer = setTimeout(broadcastData, 150);
    }
    
    function broadcastData() {
      var shortages = [];
      
      for (var i = 0; i < inventory.length; i++) {
        var item = inventory[i];
        var state = itemStates[item.key] || { checked: false, actual: 0 };
        
        if (!state.checked || state.actual < item.required) {
          var shortage = item.required - (state.actual || 0);
          shortages.push({
            area: areaName,
            category: item.category,
            name: item.name,
            required: item.required,
            actual: state.actual || 0,
            shortage: shortage
          });
        }
      }
      
      var data = {
        widgetId: widgetId,
        area: areaName,
        shortages: shortages,
        timestamp: Date.now()
      };
      
      if (typeof JFCustomWidget !== 'undefined') {
        JFCustomWidget.sendData({
          value: JSON.stringify(data)
        });
        
        if (summaryFieldId) {
          updateSummaryField(data);
        }
      }
    }
    
    function updateSummaryField(myData) {
      if (!summaryFieldId || typeof JFCustomWidget === 'undefined') return;
      
      JFCustomWidget.getFieldValue(summaryFieldId, function(existingValue) {
        var allData = {};
        
        if (existingValue) {
          try {
            allData = JSON.parse(existingValue);
          } catch (e) {
            allData = {};
          }
        }
        
        var myKey = widgetId || ('area_' + areaName.replace(/\s+/g, '_'));
        allData[myKey] = myData;
        
        JFCustomWidget.setFieldValue(summaryFieldId, JSON.stringify(allData));
      });
    }
    
    // =====================================================
    // RESIZE WIDGET
    // =====================================================
    
    function resizeWidget() {
      if (typeof JFCustomWidget === 'undefined') return;
      
      setTimeout(function() {
        var height = document.body.scrollHeight + 20;
        JFCustomWidget.requestFrameResize({ height: height });
      }, 100);
    }
    
    // =====================================================
    // INITIALIZATION
    // =====================================================
    
    var jotformReady = false;
    
    function initStandalone() {
      if (jotformReady) return;
      
      console.log("Running in standalone/test mode");
      document.getElementById('widgetTitle').textContent = "Area Checklist (Test Mode)";
      inventory = parseInventory(DEFAULT_INVENTORY);
      buildChecklist();
    }
    
    function init() {
      var fallbackTimer = setTimeout(function() {
        if (!jotformReady) {
          initStandalone();
        }
      }, 1000);
      
      if (typeof JFCustomWidget !== 'undefined' && JFCustomWidget.subscribe) {
        JFCustomWidget.subscribe("ready", function(data) {
          jotformReady = true;
          clearTimeout(fallbackTimer);
          
          areaName = JFCustomWidget.getWidgetSetting('areaName') || 'Area Checklist';
          var inventoryText = JFCustomWidget.getWidgetSetting('inventoryItems') || DEFAULT_INVENTORY;
          summaryFieldId = JFCustomWidget.getWidgetSetting('summaryFieldId') || null;
          
          widgetId = JFCustomWidget.getWidgetSetting('widgetId');
          if (!widgetId) {
            widgetId = 'area_' + areaName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
            console.warn('No widgetId configured - using generated ID: ' + widgetId);
          }
          
          document.getElementById('widgetTitle').textContent = areaName;
          inventory = parseInventory(inventoryText);
          
          if (data.value) {
            try {
              var saved = JSON.parse(data.value);
              if (saved.shortages) {
                for (var i = 0; i < inventory.length; i++) {
                  var item = inventory[i];
                  var found = false;
                  for (var j = 0; j < saved.shortages.length; j++) {
                    if (saved.shortages[j].name === item.name) {
                      itemStates[item.key] = {
                        checked: false,
                        actual: saved.shortages[j].actual
                      };
                      found = true;
                      break;
                    }
                  }
                  if (!found) {
                    itemStates[item.key] = { checked: true, actual: item.required };
                  }
                }
              }
            } catch (e) {
              console.log("Could not parse saved data:", e);
            }
          }
          
          buildChecklist();
          resizeWidget();
          broadcastData();
        });
        
        JFCustomWidget.subscribe("submit", function() {
          var shortages = [];
          
          for (var i = 0; i < inventory.length; i++) {
            var item = inventory[i];
            var state = itemStates[item.key] || { checked: false, actual: 0 };
            
            if (!state.checked || state.actual < item.required) {
              shortages.push({
                area: areaName,
                category: item.category,
                name: item.name,
                required: item.required,
                actual: state.actual || 0,
                shortage: item.required - (state.actual || 0)
              });
            }
          }
          
          var data = {
            widgetId: widgetId,
            area: areaName,
            shortages: shortages,
            timestamp: Date.now()
          };
          
          JFCustomWidget.sendSubmit({
            valid: true,
            value: JSON.stringify(data)
          });
        });
      } else {
        clearTimeout(fallbackTimer);
        initStandalone();
      }
    }
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
